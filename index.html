<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indicadores Estrat√©gicos - Sa√∫de Integral</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#879ACF',
                        secondary: '#0E334C',
                        accent: '#FA3268',
                        success: '#8CD000',
                        white: '#FFFFFF'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-primary/10 to-secondary/10 min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-secondary flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"></div>
            <h2 class="text-xl font-bold">Carregando Sistema...</h2>
            <p class="text-primary">Conectando com SharePoint</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden fixed inset-0 bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center z-40">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-secondary mb-2">INDICADORES ESTRAT√âGICOS</h1>
                <p class="text-primary">SA√öDE INTEGRAL / SALUD INTEGRAL R&D LATAM</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="loginWithMicrosoft()" class="w-full bg-secondary hover:bg-secondary/80 text-white py-3 px-6 rounded-lg font-semibold transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 23 23" fill="currentColor">
                        <path d="M1 1h10v10H1V1zm11 0h10v10H12V1zM1 12h10v10H1V12zm11 0h10v10H12V12z"/>
                    </svg>
                    Entrar com Microsoft
                </button>
                
                <div class="text-center text-xs text-gray-500">
                    <p>ou</p>
                </div>
                
                <button onclick="demoLogin()" class="w-full bg-success hover:bg-success/80 text-white py-3 px-6 rounded-lg font-semibold transition-colors flex items-center justify-center">
                    üöÄ Entrar como Ariane (Demo)
                </button>
                
                <div class="text-center text-sm text-gray-600">
                    <p class="mt-2">Sistema de Indicadores Estrat√©gicos</p>
                    <p class="font-semibold text-secondary">Sa√∫de Integral R&D LATAM</p>
                    <p class="text-xs text-gray-500 mt-2">
                        üí° Use o bot√£o Demo se houver problemas com o login Microsoft
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Access Denied Screen -->
    <div id="accessDeniedScreen" class="hidden fixed inset-0 bg-gradient-to-br from-accent/20 to-secondary/20 flex items-center justify-center z-40">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 text-center">
            <div class="text-accent text-6xl mb-4">üö´</div>
            <h2 class="text-2xl font-bold text-secondary mb-4">Acesso Negado</h2>
            <p class="text-gray-600 mb-6">Voc√™ n√£o tem permiss√£o para acessar este sistema.</p>
            <p class="text-sm text-gray-500 mb-6">Para solicitar acesso, entre em contato com o administrador:</p>
            <p class="font-semibold text-secondary mb-6">ariane.santos.ext@bayer.com</p>
            <button onclick="logout()" class="bg-accent hover:bg-accent/80 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                Sair
            </button>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-secondary text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">INDICADORES ESTRAT√âGICOS</h1>
                    <p class="text-primary">SA√öDE INTEGRAL / SALUD INTEGRAL R&D LATAM</p>
                </div>
                <div class="flex gap-4 items-center">
                    <span id="userInfo" class="text-sm text-primary"></span>
                    <button onclick="toggleLanguage()" id="languageBtn" class="bg-primary hover:bg-primary/80 px-6 py-2 rounded-lg font-semibold transition-colors">
                        üá™üá∏ Espa√±ol
                    </button>
                    <button onclick="showUserPanel()" class="bg-success hover:bg-success/80 px-6 py-2 rounded-lg font-semibold transition-colors">
                        üìù Formul√°rio
                    </button>
                    <button id="adminBtn" onclick="showAdminPanel()" class="hidden bg-accent hover:bg-accent/80 px-6 py-2 rounded-lg font-semibold transition-colors">
                        üë• Administra√ß√£o
                    </button>
                    <button onclick="logout()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg font-semibold transition-colors">
                        Sair
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Dashboard View -->
        <div id="dashboardView" class="space-y-8">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-secondary mb-6">Dashboard - Indicadores Estrat√©gicos</h2>
                
                <!-- Filters -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                    <select id="yearFilter" onchange="updateCharts()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        <option value="all" data-es="Todos los A√±os">Todos os Anos</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                    <select id="monthFilter" onchange="updateCharts()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        <option value="all" data-es="Todos los Meses">Todos os Meses</option>
                        <option value="janeiro" data-es="Enero">Janeiro</option>
                        <option value="fevereiro" data-es="Febrero">Fevereiro</option>
                        <option value="marco" data-es="Marzo">Mar√ßo</option>
                        <option value="abril" data-es="Abril">Abril</option>
                        <option value="maio" data-es="Mayo">Maio</option>
                        <option value="junho" data-es="Junio">Junho</option>
                    </select>
                    <select id="locationFilter" onchange="updateCharts()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        <option value="all" data-es="Todas las Localidades">Todas Localidades</option>
                        <option value="petrolina">Petrolina</option>
                        <option value="porto_nacional">Porto Nacional</option>
                        <option value="sorriso">Sorriso</option>
                        <option value="uberlandia">Uberl√¢ndia</option>
                    </select>
                    <select id="businessFilter" onchange="updateCharts()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        <option value="all" data-es="Todos los Negocios">Todos Neg√≥cios</option>
                        <option value="field_testing">Field Testing</option>
                        <option value="pipeline_delivery">Pipeline Delivery</option>
                        <option value="biotech">Biotech</option>
                    </select>
                    <button onclick="resetFilters()" class="bg-accent hover:bg-accent/80 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                        <span data-es="Limpiar">Limpar</span>
                    </button>
                </div>

                <!-- Real-time Statistics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-primary to-primary/80 text-white p-4 rounded-lg">
                        <h3 class="text-sm font-semibold opacity-90">Total Colaboradores</h3>
                        <p id="totalEmployees" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="bg-gradient-to-r from-success to-success/80 text-white p-4 rounded-lg">
                        <h3 class="text-sm font-semibold opacity-90">Absente√≠smo M√©dio</h3>
                        <p id="avgAbsenteeism" class="text-2xl font-bold">0%</p>
                    </div>
                    <div class="bg-gradient-to-r from-accent to-accent/80 text-white p-4 rounded-lg">
                        <h3 class="text-sm font-semibold opacity-90">Respostas Pendentes</h3>
                        <p id="pendingResponses" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="bg-gradient-to-r from-secondary to-secondary/80 text-white p-4 rounded-lg">
                        <h3 class="text-sm font-semibold opacity-90">√öltima Atualiza√ß√£o</h3>
                        <p id="lastUpdate" class="text-sm font-bold">--</p>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                    <div class="bg-gray-50 rounded-lg p-3">
                        <h3 class="text-sm font-semibold text-secondary mb-2">
                            <span data-es="Ausentismo General (%)">Absente√≠smo Geral (%)</span>
                        </h3>
                        <div class="h-48">
                            <canvas id="generalAbsenteeismChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <h3 class="text-sm font-semibold text-secondary mb-2">
                            <span data-es="Ausentismo por Localidad (%)">Absente√≠smo por Localidade (%)</span>
                        </h3>
                        <div class="h-48">
                            <canvas id="locationAbsenteeismChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <h3 class="text-sm font-semibold text-secondary mb-2">
                            <span data-es="Ausentismo por Categor√≠a CID (%)">Absente√≠smo por Categoria CID (%)</span>
                        </h3>
                        <div class="h-48">
                            <canvas id="cidAbsenteeismChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <h3 class="text-sm font-semibold text-secondary mb-2">
                            <span data-es="Tendencia Mensual (%)">Tend√™ncia Mensal (%)</span>
                        </h3>
                        <div class="h-48">
                            <canvas id="monthlyTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <h3 class="text-sm font-semibold text-secondary mb-2">
                            <span data-es="Comparativo FTE vs Temporales - Ausentismo (%)">Comparativo FTE vs Safristas - Absente√≠smo (%)</span>
                        </h3>
                        <div class="h-48">
                            <canvas id="fteVsSafristasChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <h3 class="text-sm font-semibold text-secondary mb-2">
                            <span data-es="Personas con Discapacidad por Tipo">Pessoas com Defici√™ncia por Tipo</span>
                        </h3>
                        <div class="h-48">
                            <canvas id="disabilityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden space-y-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-secondary">Painel Administrativo</h2>
                    <div class="flex gap-4">
                        <button onclick="showAddUser()" class="bg-success hover:bg-success/80 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            ‚ûï Adicionar Usu√°rio
                        </button>
                        <button onclick="showAddAdmin()" class="bg-primary hover:bg-primary/80 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            üëë Adicionar Admin
                        </button>
                        <button onclick="exportData()" class="bg-secondary hover:bg-secondary/80 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            üìä Exportar Dados
                        </button>
                        <button onclick="showDashboard()" class="bg-accent hover:bg-accent/80 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            üìà Dashboard
                        </button>
                    </div>
                </div>

                <!-- Admin Filters -->
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
                    <select id="adminUserFilter" onchange="filterAdminData()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        <option value="all">Todos Usu√°rios</option>
                    </select>
                    <select id="adminYearFilter" onchange="filterAdminData()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        <option value="all">Todos os Anos</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                    <select id="adminMonthFilter" onchange="filterAdminData()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        <option value="all">Todos os Meses</option>
                        <option value="janeiro">Janeiro</option>
                        <option value="fevereiro">Fevereiro</option>
                    </select>
                    <select id="adminLocationFilter" onchange="filterAdminData()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        <option value="all">Todas Localidades</option>
                        <option value="petrolina">Petrolina</option>
                        <option value="sorriso">Sorriso</option>
                    </select>
                    <select id="adminBusinessFilter" onchange="filterAdminData()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        <option value="all">Todos Neg√≥cios</option>
                        <option value="field_testing">Field Testing</option>
                        <option value="biotech">Biotech</option>
                    </select>
                    <button onclick="resetAdminFilters()" class="bg-primary hover:bg-primary/80 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                        Limpar Filtros
                    </button>
                </div>

                <!-- User Management Table -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-secondary mb-4">Gerenciamento de Usu√°rios</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead class="bg-secondary text-white">
                                <tr>
                                    <th class="border border-gray-300 px-4 py-2">Email</th>
                                    <th class="border border-gray-300 px-4 py-2">Nome</th>
                                    <th class="border border-gray-300 px-4 py-2">Localidade</th>
                                    <th class="border border-gray-300 px-4 py-2">Tipo</th>
                                    <th class="border border-gray-300 px-4 py-2">Status</th>
                                    <th class="border border-gray-300 px-4 py-2">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="userManagementTable">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- User Responses Table -->
                <div>
                    <h3 class="text-xl font-bold text-secondary mb-4">Respostas dos Usu√°rios</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead class="bg-secondary text-white">
                                <tr>
                                    <th class="border border-gray-300 px-4 py-2">Usu√°rio</th>
                                    <th class="border border-gray-300 px-4 py-2">Localidade</th>
                                    <th class="border border-gray-300 px-4 py-2">M√™s/Ano</th>
                                    <th class="border border-gray-300 px-4 py-2">Absente√≠smo (%)</th>
                                    <th class="border border-gray-300 px-4 py-2">Status</th>
                                    <th class="border border-gray-300 px-4 py-2">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="userResponsesTable">
                                <!-- Responses will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Panel -->
        <div id="userPanel" class="hidden space-y-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-secondary">Painel do Usu√°rio</h2>
                    <div class="flex gap-4">
                        <button onclick="showHistory()" class="bg-primary hover:bg-primary/80 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            üìä Hist√≥rico
                        </button>
                        <button onclick="showDashboard()" class="bg-accent hover:bg-accent/80 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            üìà Dashboard
                        </button>
                    </div>
                </div>

                <!-- Survey Form -->
                <form id="surveyForm" class="space-y-8">
                    <!-- Informa√ß√£o Geral -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-xl font-bold text-secondary mb-4 border-b-2 border-secondary pb-2">
                            <span data-es="INFORMACI√ìN GENERAL">INFORMA√á√ÉO GERAL</span>
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-secondary font-semibold mb-2">
                                    <span data-es="1. Informaci√≥n referente al a√±o:">1. Informa√ß√£o referente ao ano:</span>
                                </label>
                                <div class="space-y-2">
                                    <label class="flex items-center"><input type="radio" name="year" value="2024" class="mr-2" required> 2024</label>
                                    <label class="flex items-center"><input type="radio" name="year" value="2025" class="mr-2"> 2025</label>
                                </div>
                            </div>

                            <div>
                                <label class="block text-secondary font-semibold mb-2">
                                    <span data-es="2. Informaci√≥n referente al mes:">2. Informa√ß√£o referente ao m√™s:</span>
                                </label>
                                <select name="month" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" required>
                                    <option value="" data-es="Seleccione el mes">Selecione o m√™s</option>
                                    <option value="janeiro" data-es="Enero">Janeiro</option>
                                    <option value="fevereiro" data-es="Febrero">Fevereiro</option>
                                    <option value="marco" data-es="Marzo">Mar√ßo</option>
                                    <option value="abril" data-es="Abril">Abril</option>
                                    <option value="maio" data-es="Mayo">Maio</option>
                                    <option value="junho" data-es="Junio">Junho</option>
                                    <option value="julho" data-es="Julio">Julho</option>
                                    <option value="agosto" data-es="Agosto">Agosto</option>
                                    <option value="setembro" data-es="Septiembre">Setembro</option>
                                    <option value="outubro" data-es="Octubre">Outubro</option>
                                    <option value="novembro" data-es="Noviembre">Novembro</option>
                                    <option value="dezembro" data-es="Diciembre">Dezembro</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-secondary font-semibold mb-2">
                                    <span data-es="3. Negocio Principal:">3. Neg√≥cio Principal:</span>
                                </label>
                                <div class="space-y-2">
                                    <label class="flex items-center"><input type="radio" name="business" value="field_testing" class="mr-2" required> Field Testing</label>
                                    <label class="flex items-center"><input type="radio" name="business" value="pipeline_delivery" class="mr-2"> Pipeline Delivery</label>
                                    <label class="flex items-center"><input type="radio" name="business" value="biotech" class="mr-2"> Biotech</label>
                                    <label class="flex items-center"><input type="radio" name="business" value="regulatory" class="mr-2"> Regulatory</label>
                                    <label class="flex items-center"><input type="radio" name="business" value="agronomic_service" class="mr-2"> Agronomic Service</label>
                                    <label class="flex items-center"><input type="radio" name="business" value="field_solutions" class="mr-2"> Field Solutions</label>
                                    <label class="flex items-center"><input type="radio" name="business" value="vegetables" class="mr-2"> Vegetables</label>
                                </div>
                            </div>

                            <div>
                                <label class="block text-secondary font-semibold mb-2">
                                    <span data-es="4. Pa√≠s:">4. Pa√≠s:</span>
                                </label>
                                <div class="space-y-2">
                                    <label class="flex items-center"><input type="radio" name="country" value="argentina" class="mr-2" required> Argentina</label>
                                    <label class="flex items-center"><input type="radio" name="country" value="paraguai" class="mr-2"> 
                                        <span data-es="Paraguay">Paraguai</span>
                                    </label>
                                    <label class="flex items-center"><input type="radio" name="country" value="chile" class="mr-2"> Chile</label>
                                    <label class="flex items-center"><input type="radio" name="country" value="mexico" class="mr-2"> 
                                        <span data-es="M√©xico">M√©xico</span>
                                    </label>
                                    <label class="flex items-center"><input type="radio" name="country" value="guatemala" class="mr-2"> Guatemala</label>
                                    <label class="flex items-center"><input type="radio" name="country" value="el_salvador" class="mr-2"> El Salvador</label>
                                    <label class="flex items-center"><input type="radio" name="country" value="brasil" class="mr-2"> 
                                        <span data-es="Brasil">Brasil</span>
                                    </label>
                                </div>
                            </div>

                            <div class="md:col-span-2">
                                <label class="block text-secondary font-semibold mb-2">
                                    <span data-es="5. Sitio:">5. Site:</span>
                                </label>
                                <select name="site" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" required>
                                    <option value="" data-es="Seleccione el sitio">Selecione o site</option>
                                    <option value="petrolina">Petrolina</option>
                                    <option value="porto_nacional">Porto Nacional</option>
                                    <option value="sorriso">Sorriso - Hub Norte</option>
                                    <option value="coxilha">Coxilha - Hub Sul</option>
                                    <option value="rolandia">Rol√¢ndia - Hub Sul</option>
                                    <option value="santa_rita">Santa Rita - Hub Sul</option>
                                    <option value="uberlandia">Uberl√¢ndia - Hub Centro Norte</option>
                                    <option value="guatemala_el_salvador">Guatemala / El Salvador - Hub Norla</option>
                                    <option value="uberlandia_ctb">Uberl√¢ndia CTB</option>
                                    <option value="nao_me_toque">N√£o Me Toque</option>
                                    <option value="santa_cruz">Santa Cruz das Palmeiras</option>
                                    <option value="paulinia">Paul√≠nia</option>
                                    <option value="carandai">Caranda√≠</option>
                                    <option value="luis_eduardo">Lu√≠s Eduardo Magalh√£es</option>
                                    <option value="fontezuela">Fontezuela</option>
                                    <option value="santa_julia">Santa Julia / Temuco</option>
                                    <option value="el_tizate">El Tizate</option>
                                    <option value="san_juan">San Juan de Abajo</option>
                                    <option value="la_charca">La Charca</option>
                                    <option value="tlajomulco">Tlajomulco</option>
                                    <option value="rio_iv">Rio IV</option>
                                    <option value="outro" data-es="Otro">Outro</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-secondary font-semibold mb-2">
                                    <span data-es="6. Cantidad de FTE activo del sitio:">6. Quantidade de FTE ativo do site:</span>
                                </label>
                                <input type="number" name="fte_count" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" onkeypress="return event.charCode >= 48 && event.charCode <= 57" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required>
                            </div>

                            <div>
                                <label class="block text-secondary font-semibold mb-2">
                                    <span data-es="7. Cantidad de temporales activos del sitio:">7. Quantidade de safristas ativos do site:</span>
                                </label>
                                <input type="number" name="seasonal_count" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" onkeypress="return event.charCode >= 48 && event.charCode <= 57" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required>
                            </div>

                            <div class="md:col-span-2">
                                <label class="block text-secondary font-semibold mb-2">
                                    <span data-es="8. Campo abierto para observaci√≥n:">8. Campo aberto para observa√ß√£o:</span>
                                </label>
                                <textarea name="general_observation" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Licen√ßa M√©dica -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-xl font-bold text-secondary mb-4 border-b-2 border-secondary pb-2">
                            <span data-es="LICENCIA M√âDICA (solo n√∫meros)">LICEN√áA M√âDICA (apenas n√∫meros)</span>
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-secondary font-semibold mb-2">9. Dias de licen√ßa m√©dica (todos os motivos) - FTE:</label>
                                <input type="number" name="medical_leave_fte" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" onkeypress="return event.charCode >= 48 && event.charCode <= 57" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required>
                            </div>

                            <div>
                                <label class="block text-secondary font-semibold mb-2">10. Dias de licen√ßa m√©dica (todos os motivos) - Safristas:</label>
                                <input type="number" name="medical_leave_seasonal" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" onkeypress="return event.charCode >= 48 && event.charCode <= 57" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required>
                            </div>

                            <!-- Continue with all other medical leave fields... -->
                            <div>
                                <label class="block text-secondary font-semibold mb-2">11. Dias de licen√ßa m√©dica por CID F - FTE:</label>
                                <input type="number" name="cid_f_fte" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" onkeypress="return event.charCode >= 48 && event.charCode <= 57" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                            </div>

                            <div>
                                <label class="block text-secondary font-semibold mb-2">12. Dias de licen√ßa m√©dica por CID F - Safristas:</label>
                                <input type="number" name="cid_f_seasonal" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" onkeypress="return event.charCode >= 48 && event.charCode <= 57" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                            </div>

                            <!-- Add all other CID fields similarly... -->
                            
                            <div class="md:col-span-2">
                                <label class="block text-secondary font-semibold mb-2">27. Campo aberto para observa√ß√£o:</label>
                                <textarea name="medical_observation" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex justify-center">
                        <button type="submit" class="bg-success hover:bg-success/80 text-white px-8 py-3 rounded-lg font-bold text-lg transition-colors">
                            üíæ <span data-es="Guardar Respuestas">Salvar Respostas</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add User Modal -->
        <div id="addUserModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
                <h2 class="text-2xl font-bold text-secondary mb-6 text-center">Adicionar Novo Usu√°rio</h2>
                <form id="addUserForm" class="space-y-4">
                    <div>
                        <label class="block text-secondary font-semibold mb-2">Email Corporativo:</label>
                        <input type="email" id="newUserEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required placeholder="usuario@bayer.com">
                    </div>
                    <div>
                        <label class="block text-secondary font-semibold mb-2">Nome Completo:</label>
                        <input type="text" id="newUserName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                    </div>
                    <div>
                        <label class="block text-secondary font-semibold mb-2">Localidade Principal:</label>
                        <select id="newUserLocation" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                            <option value="">Selecione a localidade</option>
                            <option value="petrolina">Petrolina</option>
                            <option value="sorriso">Sorriso</option>
                            <option value="uberlandia">Uberl√¢ndia</option>
                            <option value="porto_nacional">Porto Nacional</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-secondary font-semibold mb-2">Neg√≥cio:</label>
                        <select id="newUserBusiness" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                            <option value="">Selecione o neg√≥cio</option>
                            <option value="field_testing">Field Testing</option>
                            <option value="pipeline_delivery">Pipeline Delivery</option>
                            <option value="biotech">Biotech</option>
                            <option value="regulatory">Regulatory</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-success hover:bg-success/80 text-white py-3 rounded-lg font-semibold transition-colors">
                        Adicionar Usu√°rio
                    </button>
                    <button type="button" onclick="closeAddUserModal()" class="w-full text-gray-500 hover:text-gray-700">
                        Cancelar
                    </button>
                </form>
            </div>
        </div>

        <!-- Add Admin Modal -->
        <div id="addAdminModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
                <h2 class="text-2xl font-bold text-secondary mb-6 text-center">Adicionar Novo Administrador</h2>
                <form id="addAdminForm" class="space-y-4">
                    <div>
                        <label class="block text-secondary font-semibold mb-2">Email Corporativo:</label>
                        <input type="email" id="newAdminEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required placeholder="admin@bayer.com">
                    </div>
                    <div>
                        <label class="block text-secondary font-semibold mb-2">Nome Completo:</label>
                        <input type="text" id="newAdminName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p class="text-sm text-yellow-800">
                            ‚ö†Ô∏è <strong>Aten√ß√£o:</strong> Administradores t√™m acesso total ao sistema, incluindo visualiza√ß√£o de todos os dados e gerenciamento de usu√°rios.
                        </p>
                    </div>
                    <button type="submit" class="w-full bg-accent hover:bg-accent/80 text-white py-3 rounded-lg font-semibold transition-colors">
                        Adicionar Administrador
                    </button>
                    <button type="button" onclick="closeAddAdminModal()" class="w-full text-gray-500 hover:text-gray-700">
                        Cancelar
                    </button>
                </form>
            </div>
        </div>
    </main>

    <script>
        // MSAL Configuration - Fixed for Bayer tenant
        const msalConfig = {
            auth: {
                clientId: "04b07795-8ddb-461a-bbee-02f9e1bf7b46", // Microsoft Azure CLI Client ID (public client)
                authority: "https://login.microsoftonline.com/organizations", // Organizations only
                redirectUri: window.location.origin
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false
            }
        };

        // SharePoint Configuration
        const SHAREPOINT_CONFIG = {
            siteUrl: "https://bayergroupus.sharepoint.com/sites/038276",
            listsPath: "/Shared Documents/Brasil/App Indicadores",
            lists: {
                users: "IndicadoresUsers",
                responses: "IndicadoresResponses",
                admins: "IndicadoresAdmins"
            }
        };

        // Global variables
        let msalInstance;
        let currentUser = null;
        let currentLanguage = 'pt';
        let charts = {};
        let allUsers = [];
        let allResponses = [];
        let isAdmin = false;

        // Initialize MSAL
        function initializeMSAL() {
            msalInstance = new msal.PublicClientApplication(msalConfig);
            
            // Handle redirect promise
            msalInstance.handleRedirectPromise().then((response) => {
                if (response) {
                    currentUser = response.account;
                    checkUserAccess();
                } else {
                    // Check if user is already logged in
                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length > 0) {
                        currentUser = accounts[0];
                        checkUserAccess();
                    } else {
                        showLoginScreen();
                    }
                }
            }).catch((error) => {
                console.error("MSAL Error:", error);
                showLoginScreen();
            });
        }

        // Demo login function
        function demoLogin() {
            currentUser = {
                username: "ariane.santos.ext@bayer.com",
                name: "Ariane Santos"
            };
            console.log("Demo login successful:", currentUser);
            checkUserAccess();
        }

        // Login with Microsoft
        async function loginWithMicrosoft() {
            const loginRequest = {
                scopes: ["User.Read", "openid", "profile", "email"]
            };

            try {
                // Try popup first, fallback to redirect
                const response = await msalInstance.loginPopup(loginRequest);
                currentUser = response.account;
                console.log("Login successful:", currentUser);
                checkUserAccess();
            } catch (error) {
                console.error("Login failed:", error);
                
                // Show detailed error message
                let errorMessage = "Erro no login Microsoft:\n\n";
                if (error.errorCode === "AADSTS65002") {
                    errorMessage += "Problema de configura√ß√£o do Azure AD.\n";
                } else if (error.errorCode === "popup_window_error") {
                    errorMessage += "Popup bloqueado pelo navegador.\n";
                } else {
                    errorMessage += `C√≥digo: ${error.errorCode || 'Desconhecido'}\n`;
                }
                errorMessage += "\nDeseja continuar como Ariane (Administradora) para testar o sistema?";
                
                if (confirm(errorMessage)) {
                    // Demo mode for Ariane
                    currentUser = {
                        username: "ariane.santos.ext@bayer.com",
                        name: "Ariane Santos (Demo Mode)"
                    };
                    checkUserAccess();
                } else {
                    // Try redirect as fallback
                    try {
                        await msalInstance.loginRedirect(loginRequest);
                    } catch (redirectError) {
                        console.error("Redirect login also failed:", redirectError);
                        alert("N√£o foi poss√≠vel fazer login. Entre em contato com o suporte t√©cnico.");
                    }
                }
            }
        }

        // Check user access
        async function checkUserAccess() {
            if (!currentUser) {
                showLoginScreen();
                return;
            }

            const userEmail = currentUser.username.toLowerCase();
            
            // Check if user is super admin
            if (userEmail === 'ariane.santos.ext@bayer.com') {
                isAdmin = true;
                await initializeSystem();
                return;
            }

            // Check if user is in admin list
            const adminList = await getSharePointList('admins');
            const isAdminUser = adminList.some(admin => admin.email.toLowerCase() === userEmail);
            
            if (isAdminUser) {
                isAdmin = true;
                await initializeSystem();
                return;
            }

            // Check if user is in authorized users list
            const usersList = await getSharePointList('users');
            const authorizedUser = usersList.find(user => user.email.toLowerCase() === userEmail);
            
            if (authorizedUser) {
                isAdmin = false;
                await initializeSystem();
                return;
            }

            // User not authorized
            showAccessDenied();
        }

        // Initialize system after authentication
        async function initializeSystem() {
            hideLoadingScreen();
            
            // Update UI based on user role
            document.getElementById('userInfo').textContent = `${currentUser.name} (${currentUser.username})`;
            
            if (isAdmin) {
                document.getElementById('adminBtn').classList.remove('hidden');
            }

            // Initialize demo data if needed
            await initializeDemoData();
            
            // Load data and initialize dashboard
            await loadAllData();
            initDashboard();
            showDashboard();
        }

        // Initialize demo data for testing
        async function initializeDemoData() {
            // Check if demo data already exists
            const existingUsers = await getSharePointList('users');
            const existingAdmins = await getSharePointList('admins');
            
            // Add Ariane as admin if not exists
            if (existingAdmins.length === 0) {
                await addToSharePointList('admins', {
                    email: "ariane.santos.ext@bayer.com",
                    name: "Ariane Santos",
                    added_by: "system",
                    added_date: new Date().toISOString(),
                    status: "Active"
                });
            }
            
            // Add some demo users if none exist
            if (existingUsers.length === 0) {
                const demoUsers = [
                    {
                        email: "user1@bayer.com",
                        name: "Usu√°rio Demo 1",
                        location: "petrolina",
                        business: "field_testing",
                        added_by: "ariane.santos.ext@bayer.com",
                        added_date: new Date().toISOString(),
                        status: "Active"
                    },
                    {
                        email: "user2@bayer.com", 
                        name: "Usu√°rio Demo 2",
                        location: "sorriso",
                        business: "biotech",
                        added_by: "ariane.santos.ext@bayer.com",
                        added_date: new Date().toISOString(),
                        status: "Active"
                    }
                ];
                
                for (const user of demoUsers) {
                    await addToSharePointList('users', user);
                }
            }
        }

        // SharePoint API functions - Simplified for demo
        async function getAccessToken() {
            // For demo purposes, return a mock token
            return "demo-token";
        }

        // Get SharePoint list data - Using localStorage for demo
        async function getSharePointList(listType) {
            try {
                // For demo, use localStorage to simulate SharePoint
                const storageKey = `sharepoint_${listType}`;
                const data = localStorage.getItem(storageKey);
                
                if (data) {
                    return JSON.parse(data);
                }
                
                // Initialize with empty data if not exists
                const emptyData = [];
                localStorage.setItem(storageKey, JSON.stringify(emptyData));
                return emptyData;
            } catch (error) {
                console.error(`Error fetching ${listType} list:`, error);
                return [];
            }
        }

        // Add item to SharePoint list - Using localStorage for demo
        async function addToSharePointList(listType, item) {
            try {
                const storageKey = `sharepoint_${listType}`;
                const existingData = JSON.parse(localStorage.getItem(storageKey) || '[]');
                
                // Add ID and timestamp
                const newItem = {
                    ...item,
                    Id: Date.now().toString(),
                    Created: new Date().toISOString()
                };
                
                existingData.push(newItem);
                localStorage.setItem(storageKey, JSON.stringify(existingData));
                
                console.log(`Item added to ${listType}:`, newItem);
                return { d: newItem };
            } catch (error) {
                console.error(`Error adding to ${listType} list:`, error);
                throw error;
            }
        }

        // Load all data from SharePoint
        async function loadAllData() {
            try {
                allUsers = await getSharePointList('users');
                allResponses = await getSharePointList('responses');
                
                // Update statistics
                updateStatistics();
                
                if (isAdmin) {
                    populateAdminTables();
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Update real-time statistics from SharePoint data
        function updateStatistics() {
            const totalEmployees = allResponses.reduce((sum, response) => {
                return sum + (parseInt(response.fte_count) || 0) + (parseInt(response.seasonal_count) || 0);
            }, 0);

            const totalAbsenteeism = allResponses.reduce((sum, response) => {
                const fte = parseInt(response.fte_count) || 0;
                const seasonal = parseInt(response.seasonal_count) || 0;
                const medicalFte = parseInt(response.medical_leave_fte) || 0;
                const medicalSeasonal = parseInt(response.medical_leave_seasonal) || 0;
                
                if (fte + seasonal > 0) {
                    return sum + ((medicalFte + medicalSeasonal) / (fte + seasonal)) * 100;
                }
                return sum;
            }, 0);

            const avgAbsenteeism = allResponses.length > 0 ? (totalAbsenteeism / allResponses.length).toFixed(1) : 0;
            const pendingResponses = Math.max(0, allUsers.length - allResponses.length);
            const lastUpdate = allResponses.length > 0 ? 
                new Date(Math.max(...allResponses.map(r => new Date(r.Created || r.submission_date)))).toLocaleDateString('pt-BR') : 
                'Nenhum dado ainda';

            document.getElementById('totalEmployees').textContent = totalEmployees.toLocaleString();
            document.getElementById('avgAbsenteeism').textContent = `${avgAbsenteeism}%`;
            document.getElementById('pendingResponses').textContent = pendingResponses;
            document.getElementById('lastUpdate').textContent = lastUpdate;
        }

        // Populate admin tables
        function populateAdminTables() {
            // User management table
            const userTable = document.getElementById('userManagementTable');
            userTable.innerHTML = '';

            allUsers.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2">${user.email}</td>
                    <td class="border border-gray-300 px-4 py-2">${user.name}</td>
                    <td class="border border-gray-300 px-4 py-2">${user.location}</td>
                    <td class="border border-gray-300 px-4 py-2">
                        <span class="bg-primary text-white px-2 py-1 rounded text-sm">Usu√°rio</span>
                    </td>
                    <td class="border border-gray-300 px-4 py-2">
                        <span class="bg-success text-white px-2 py-1 rounded text-sm">Ativo</span>
                    </td>
                    <td class="border border-gray-300 px-4 py-2">
                        <button onclick="removeUser('${user.Id}')" class="bg-accent hover:bg-accent/80 text-white px-3 py-1 rounded text-sm">
                            Remover
                        </button>
                    </td>
                `;
                userTable.appendChild(row);
            });

            // User responses table
            const responseTable = document.getElementById('userResponsesTable');
            responseTable.innerHTML = '';

            allResponses.forEach(response => {
                const user = allUsers.find(u => u.email === response.user_email);
                const absenteeism = calculateAbsenteeism(response);
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2">${user ? user.name : response.user_email}</td>
                    <td class="border border-gray-300 px-4 py-2">${response.site}</td>
                    <td class="border border-gray-300 px-4 py-2">${response.month}/${response.year}</td>
                    <td class="border border-gray-300 px-4 py-2">${absenteeism.toFixed(1)}%</td>
                    <td class="border border-gray-300 px-4 py-2">
                        <span class="bg-success text-white px-2 py-1 rounded text-sm">Respondido</span>
                    </td>
                    <td class="border border-gray-300 px-4 py-2">
                        <button onclick="viewResponse('${response.Id}')" class="bg-primary hover:bg-primary/80 text-white px-3 py-1 rounded text-sm">
                            Ver Detalhes
                        </button>
                    </td>
                `;
                responseTable.appendChild(row);
            });
        }

        // Calculate absenteeism percentage
        function calculateAbsenteeism(response) {
            const fte = parseInt(response.fte_count) || 0;
            const seasonal = parseInt(response.seasonal_count) || 0;
            const medicalFte = parseInt(response.medical_leave_fte) || 0;
            const medicalSeasonal = parseInt(response.medical_leave_seasonal) || 0;
            
            const totalEmployees = fte + seasonal;
            const totalAbsences = medicalFte + medicalSeasonal;
            
            if (totalEmployees === 0) return 0;
            
            // Assuming 22 working days per month
            const workingDays = 22;
            return (totalAbsences / (totalEmployees * workingDays)) * 100;
        }

        // Form submission handler
        document.getElementById('surveyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const responseData = {
                __metadata: { type: "SP.Data.IndicadoresResponsesListItem" },
                user_email: currentUser.username,
                user_name: currentUser.name,
                year: formData.get('year'),
                month: formData.get('month'),
                business: formData.get('business'),
                country: formData.get('country'),
                site: formData.get('site'),
                fte_count: formData.get('fte_count'),
                seasonal_count: formData.get('seasonal_count'),
                general_observation: formData.get('general_observation'),
                medical_leave_fte: formData.get('medical_leave_fte'),
                medical_leave_seasonal: formData.get('medical_leave_seasonal'),
                // Add all other form fields...
                submission_date: new Date().toISOString()
            };

            try {
                await addToSharePointList('responses', responseData);
                alert('Respostas salvas com sucesso no SharePoint!\n\nObrigado por preencher os indicadores estrat√©gicos.');
                
                // Reload data and update dashboard
                await loadAllData();
                updateCharts();
                
                // Reset form
                e.target.reset();
            } catch (error) {
                console.error('Error saving response:', error);
                alert('Erro ao salvar respostas. Tente novamente.');
            }
        });

        // Add user form handler
        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userData = {
                __metadata: { type: "SP.Data.IndicadoresUsersListItem" },
                email: document.getElementById('newUserEmail').value,
                name: document.getElementById('newUserName').value,
                location: document.getElementById('newUserLocation').value,
                business: document.getElementById('newUserBusiness').value,
                added_by: currentUser.username,
                added_date: new Date().toISOString(),
                status: 'Active'
            };

            try {
                await addToSharePointList('users', userData);
                alert(`Usu√°rio adicionado com sucesso!\n\nEmail: ${userData.email}\nNome: ${userData.name}\n\nO usu√°rio agora pode acessar o sistema.`);
                
                closeAddUserModal();
                document.getElementById('addUserForm').reset();
                
                // Reload data
                await loadAllData();
            } catch (error) {
                console.error('Error adding user:', error);
                alert('Erro ao adicionar usu√°rio. Tente novamente.');
            }
        });

        // Add admin form handler
        document.getElementById('addAdminForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const adminData = {
                __metadata: { type: "SP.Data.IndicadoresAdminsListItem" },
                email: document.getElementById('newAdminEmail').value,
                name: document.getElementById('newAdminName').value,
                added_by: currentUser.username,
                added_date: new Date().toISOString(),
                status: 'Active'
            };

            try {
                await addToSharePointList('admins', adminData);
                alert(`Administrador adicionado com sucesso!\n\nEmail: ${adminData.email}\nNome: ${adminData.name}\n\nO usu√°rio agora tem privil√©gios administrativos.`);
                
                closeAddAdminModal();
                document.getElementById('addAdminForm').reset();
            } catch (error) {
                console.error('Error adding admin:', error);
                alert('Erro ao adicionar administrador. Tente novamente.');
            }
        });

        // Export data function
        async function exportData() {
            try {
                const csvContent = generateCSV();
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `indicadores_estrategicos_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Erro ao exportar dados. Tente novamente.');
            }
        }

        // Generate CSV content
        function generateCSV() {
            const headers = [
                'Usuario', 'Email', 'Localidade', 'Mes', 'Ano', 'Negocio', 'Pais', 'Site',
                'FTE_Count', 'Seasonal_Count', 'Medical_Leave_FTE', 'Medical_Leave_Seasonal',
                'Absenteeism_Percentage', 'Submission_Date'
            ];

            const rows = allResponses.map(response => {
                const user = allUsers.find(u => u.email === response.user_email);
                const absenteeism = calculateAbsenteeism(response);
                
                return [
                    user ? user.name : response.user_name,
                    response.user_email,
                    response.site,
                    response.month,
                    response.year,
                    response.business,
                    response.country,
                    response.site,
                    response.fte_count,
                    response.seasonal_count,
                    response.medical_leave_fte,
                    response.medical_leave_seasonal,
                    absenteeism.toFixed(2),
                    new Date(response.submission_date).toLocaleDateString('pt-BR')
                ].map(field => `"${field}"`).join(',');
            });

            return [headers.join(','), ...rows].join('\n');
        }

        // UI Helper Functions
        function showLoginScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function hideLoadingScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function showAccessDenied() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('accessDeniedScreen').classList.remove('hidden');
        }

        function showAddUser() {
            document.getElementById('addUserModal').classList.remove('hidden');
            document.getElementById('addUserModal').classList.add('flex');
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.add('hidden');
            document.getElementById('addUserModal').classList.remove('flex');
        }

        function showAddAdmin() {
            document.getElementById('addAdminModal').classList.remove('hidden');
            document.getElementById('addAdminModal').classList.add('flex');
        }

        function closeAddAdminModal() {
            document.getElementById('addAdminModal').classList.add('hidden');
            document.getElementById('addAdminModal').classList.remove('flex');
        }

        function showAdminPanel() {
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('userPanel').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
        }

        function showUserPanel() {
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('userPanel').classList.remove('hidden');
        }

        function showDashboard() {
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('userPanel').classList.add('hidden');
            document.getElementById('dashboardView').classList.remove('hidden');
        }

        function logout() {
            if (msalInstance) {
                msalInstance.logoutPopup();
            }
            currentUser = null;
            isAdmin = false;
            location.reload();
        }

        // Chart initialization and other functions remain the same...
        // [Include all the chart functions from the previous version]

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeMSAL();
        });

        // Initialize dashboard with charts
        function initDashboard() {
            initCharts();
            updateCharts();
        }

        // Initialize all charts with SharePoint data
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { size: 10 } }
                    }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            };

            // General Absenteeism Chart
            charts.generalAbsenteeism = new Chart(document.getElementById('generalAbsenteeismChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Absente√≠smo Geral (%)',
                        data: [],
                        borderColor: '#879ACF',
                        backgroundColor: 'rgba(135, 154, 207, 0.1)',
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });

            // Location Absenteeism Chart
            charts.locationAbsenteeism = new Chart(document.getElementById('locationAbsenteeismChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Absente√≠smo por Localidade (%)',
                        data: [],
                        backgroundColor: ['#879ACF', '#0E334C', '#FA3268', '#8CD000']
                    }]
                },
                options: chartOptions
            });

            // CID Absenteeism Chart
            charts.cidAbsenteeism = new Chart(document.getElementById('cidAbsenteeismChart'), {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#879ACF', '#0E334C', '#FA3268', '#8CD000', '#FF9500']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 8 } }
                        }
                    }
                }
            });

            // Monthly Trend Chart
            charts.monthlyTrend = new Chart(document.getElementById('monthlyTrendChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Tend√™ncia Mensal (%)',
                        data: [],
                        borderColor: '#FA3268',
                        backgroundColor: 'rgba(250, 50, 104, 0.1)',
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });

            // FTE vs Safristas Chart
            charts.fteVsSafristas = new Chart(document.getElementById('fteVsSafristasChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'FTE (%)',
                        data: [],
                        backgroundColor: '#879ACF'
                    }, {
                        label: 'Safristas (%)',
                        data: [],
                        backgroundColor: '#8CD000'
                    }]
                },
                options: chartOptions
            });

            // Disability Chart
            charts.disability = new Chart(document.getElementById('disabilityChart'), {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#879ACF', '#0E334C', '#FA3268', '#8CD000']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 8 } }
                        }
                    }
                }
            });
        }

        // Update charts with filtered SharePoint data
        function updateCharts() {
            const filteredData = getFilteredData();
            
            // Update General Absenteeism Chart
            const monthlyData = processMonthlyAbsenteeism(filteredData);
            charts.generalAbsenteeism.data.labels = monthlyData.labels;
            charts.generalAbsenteeism.data.datasets[0].data = monthlyData.data;
            charts.generalAbsenteeism.update();

            // Update Location Absenteeism Chart
            const locationData = processLocationAbsenteeism(filteredData);
            charts.locationAbsenteeism.data.labels = locationData.labels;
            charts.locationAbsenteeism.data.datasets[0].data = locationData.data;
            charts.locationAbsenteeism.update();

            // Update CID Absenteeism Chart
            const cidData = processCIDAbsenteeism(filteredData);
            charts.cidAbsenteeism.data.labels = cidData.labels;
            charts.cidAbsenteeism.data.datasets[0].data = cidData.data;
            charts.cidAbsenteeism.update();

            // Update Monthly Trend Chart
            charts.monthlyTrend.data.labels = monthlyData.labels;
            charts.monthlyTrend.data.datasets[0].data = monthlyData.data;
            charts.monthlyTrend.update();

            // Update FTE vs Safristas Chart
            const fteData = processFTEVsSafristas(filteredData);
            charts.fteVsSafristas.data.labels = fteData.labels;
            charts.fteVsSafristas.data.datasets[0].data = fteData.fteData;
            charts.fteVsSafristas.data.datasets[1].data = fteData.safristasData;
            charts.fteVsSafristas.update();

            // Update Disability Chart (placeholder - will be populated when data is available)
            charts.disability.data.labels = ['F√≠sica', 'Visual', 'Auditiva', 'Intelectual'];
            charts.disability.data.datasets[0].data = [0, 0, 0, 0];
            charts.disability.update();
        }

        // Get filtered data based on current filter selections
        function getFilteredData() {
            let filtered = [...allResponses];
            
            const yearFilter = document.getElementById('yearFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            const locationFilter = document.getElementById('locationFilter').value;
            const businessFilter = document.getElementById('businessFilter').value;

            if (yearFilter !== 'all') {
                filtered = filtered.filter(r => r.year === yearFilter);
            }
            if (monthFilter !== 'all') {
                filtered = filtered.filter(r => r.month === monthFilter);
            }
            if (locationFilter !== 'all') {
                filtered = filtered.filter(r => r.site === locationFilter);
            }
            if (businessFilter !== 'all') {
                filtered = filtered.filter(r => r.business === businessFilter);
            }

            return filtered;
        }

        // Process monthly absenteeism data
        function processMonthlyAbsenteeism(data) {
            const monthlyStats = {};
            
            data.forEach(response => {
                const key = `${response.month}/${response.year}`;
                if (!monthlyStats[key]) {
                    monthlyStats[key] = { total: 0, count: 0 };
                }
                monthlyStats[key].total += calculateAbsenteeism(response);
                monthlyStats[key].count += 1;
            });

            const labels = Object.keys(monthlyStats).sort();
            const chartData = labels.map(key => 
                monthlyStats[key].count > 0 ? (monthlyStats[key].total / monthlyStats[key].count) : 0
            );

            return { labels, data: chartData };
        }

        // Process location absenteeism data
        function processLocationAbsenteeism(data) {
            const locationStats = {};
            
            data.forEach(response => {
                const location = response.site;
                if (!locationStats[location]) {
                    locationStats[location] = { total: 0, count: 0 };
                }
                locationStats[location].total += calculateAbsenteeism(response);
                locationStats[location].count += 1;
            });

            const labels = Object.keys(locationStats);
            const chartData = labels.map(location => 
                locationStats[location].count > 0 ? (locationStats[location].total / locationStats[location].count) : 0
            );

            return { labels, data: chartData };
        }

        // Process CID absenteeism data
        function processCIDAbsenteeism(data) {
            const cidStats = {
                'CID F': 0,
                'CID M': 0,
                'CID S': 0,
                'CID Z': 0,
                'Outros': 0
            };

            data.forEach(response => {
                cidStats['CID F'] += parseInt(response.cid_f_fte || 0) + parseInt(response.cid_f_seasonal || 0);
                // Add other CID categories when form fields are complete
            });

            const labels = Object.keys(cidStats);
            const chartData = Object.values(cidStats);

            return { labels, data: chartData };
        }

        // Process FTE vs Safristas data
        function processFTEVsSafristas(data) {
            const locations = [...new Set(data.map(r => r.site))];
            const fteData = [];
            const safristasData = [];

            locations.forEach(location => {
                const locationData = data.filter(r => r.site === location);
                let fteAbsenteeism = 0;
                let safristasAbsenteeism = 0;
                let count = 0;

                locationData.forEach(response => {
                    const fte = parseInt(response.fte_count) || 0;
                    const seasonal = parseInt(response.seasonal_count) || 0;
                    const medicalFte = parseInt(response.medical_leave_fte) || 0;
                    const medicalSeasonal = parseInt(response.medical_leave_seasonal) || 0;

                    if (fte > 0) {
                        fteAbsenteeism += (medicalFte / (fte * 22)) * 100;
                    }
                    if (seasonal > 0) {
                        safristasAbsenteeism += (medicalSeasonal / (seasonal * 22)) * 100;
                    }
                    count++;
                });

                fteData.push(count > 0 ? fteAbsenteeism / count : 0);
                safristasData.push(count > 0 ? safristasAbsenteeism / count : 0);
            });

            return { labels: locations, fteData, safristasData };
        }

        // Reset all filters
        function resetFilters() {
            document.getElementById('yearFilter').value = 'all';
            document.getElementById('monthFilter').value = 'all';
            document.getElementById('locationFilter').value = 'all';
            document.getElementById('businessFilter').value = 'all';
            updateCharts();
        }

        // Toggle language between Portuguese and Spanish
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'pt' ? 'es' : 'pt';
            const langBtn = document.getElementById('languageBtn');
            
            if (currentLanguage === 'es') {
                langBtn.innerHTML = 'üáßüá∑ Portugu√™s';
                translateToSpanish();
            } else {
                langBtn.innerHTML = 'üá™üá∏ Espa√±ol';
                translateToPortuguese();
            }
        }

        // Translate interface to Spanish
        function translateToSpanish() {
            document.querySelectorAll('[data-es]').forEach(element => {
                element.textContent = element.getAttribute('data-es');
            });
        }

        // Translate interface back to Portuguese
        function translateToPortuguese() {
            // Reset to original Portuguese text
            location.reload();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96d7c779e6f7fe12',t:'MTc1NDkxNTc5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

