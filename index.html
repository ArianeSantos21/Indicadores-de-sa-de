<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indicadores Estratégicos - Saúde Integral</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Sistema de dados compartilhados via localStorage -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#879ACF',
                        secondary: '#0E334C',
                        accent: '#FA3268',
                        success: '#8CD000',
                        white: '#FFFFFF'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-primary/10 to-secondary/10 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-secondary via-secondary to-primary text-white shadow-2xl border-b-4 border-accent">
        <div class="container mx-auto px-6 py-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="bg-white p-2 rounded-xl shadow-lg">
                        <img src="https://logosdown.com/wp-content/uploads/2023/08/bayer-logo-0-1536x1536.png" alt="Bayer Logo" class="w-10 h-10 object-contain">
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold tracking-tight" data-translate="main_title">INDICADORES ESTRATÉGICOS</h1>
                        <p class="text-primary/90 font-medium text-lg" data-translate="subtitle">SAÚDE INTEGRAL R&D LATAM</p>
                    </div>
                </div>
                <div class="flex gap-4 items-center">
                    <div class="flex gap-3">
                        <button onclick="changeLanguage('pt')" id="btnPT" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl text-sm font-bold transition-all duration-300 border border-white/30 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-2">
                            <img src="https://static.todamateria.com.br/upload/ba/nd/bandeira-do-brasil-og.jpg" alt="Brasil" class="w-5 h-3 object-cover rounded-sm shadow-sm border border-white/20">
                            PT
                        </button>
                        <button onclick="changeLanguage('es')" id="btnES" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-xl text-sm font-bold transition-all duration-300 border border-white/20 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-2">
                            <img src="https://imagepng.org/wp-content/uploads/2017/09/bandeira-espanha.png" alt="España" class="w-5 h-3 object-cover rounded-sm shadow-sm border border-white/20">
                            ES
                        </button>
                    </div>
                    <div class="w-px h-6 bg-white/30"></div>
                    <button onclick="showLogin('user')" class="bg-gradient-to-r from-primary to-primary/80 hover:from-primary/90 hover:to-primary/70 px-6 py-3 rounded-xl font-bold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 border border-white/20">
                        <span data-translate="user_button">Usuário</span>
                    </button>
                    <button onclick="showLogin('admin')" class="bg-gradient-to-r from-accent to-accent/80 hover:from-accent/90 hover:to-accent/70 px-6 py-3 rounded-xl font-bold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 border border-white/20">
                        <span data-translate="admin_button">Administrador</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Dashboard -->
    <main id="dashboard" class="container mx-auto px-6 py-8 min-h-screen">


        <!-- Chart Filters -->
        <div class="bg-gradient-to-r from-white to-gray-50 rounded-2xl shadow-2xl p-8 mb-8 border border-gray-100">
            <div class="flex items-center mb-6">
                <div class="bg-gradient-to-r from-primary to-accent p-3 rounded-xl mr-4">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-secondary" data-translate="chart_filters">Filtros dos Gráficos</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="relative">
                    <label class="block text-sm font-semibold text-secondary mb-2" data-translate="country_label">País</label>
                    <select id="chartFilterCountry" onchange="updateCharts()" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-primary/20 focus:border-primary transition-all duration-300 bg-white shadow-sm hover:shadow-md">
                        <option value="" data-translate="all_countries">Todos os Países</option>
                        <option value="brasil">Brasil</option>
                        <option value="argentina">Argentina</option>
                        <option value="chile">Chile</option>
                        <option value="mexico">México</option>
                    </select>
                </div>
                <div class="relative">
                    <label class="block text-sm font-semibold text-secondary mb-2" data-translate="location_label">Localidade</label>
                    <select id="chartFilterSite" onchange="updateCharts()" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-primary/20 focus:border-primary transition-all duration-300 bg-white shadow-sm hover:shadow-md">
                        <option value="" data-translate="all_locations">Todas as Localidades</option>
                        <option value="petrolina">Petrolina</option>
                        <option value="sorriso">Sorriso</option>
                        <option value="uberlandia">Uberlândia</option>
                        <option value="rolandia">Rolândia</option>
                    </select>
                </div>
                <div class="relative">
                    <label class="block text-sm font-semibold text-secondary mb-2" data-translate="business_label">Negócio</label>
                    <select id="chartFilterBusiness" onchange="updateCharts()" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-primary/20 focus:border-primary transition-all duration-300 bg-white shadow-sm hover:shadow-md">
                        <option value="" data-translate="all_businesses">Todos os Negócios</option>
                        <option value="field-testing">Field Testing</option>
                        <option value="pipeline-delivery">Pipeline Delivery</option>
                        <option value="biotech">Biotech</option>
                    </select>
                </div>
                <div class="relative">
                    <label class="block text-sm font-semibold text-secondary mb-2" data-translate="year_label">Ano</label>
                    <select id="chartFilterYear" onchange="updateCharts()" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-primary/20 focus:border-primary transition-all duration-300 bg-white shadow-sm hover:shadow-md">
                        <option value="" data-translate="all_years">Todos os Anos</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-2xl p-8 border border-gray-100 hover:shadow-3xl transition-all duration-300">
                <div class="flex items-center mb-6">
                    <div class="bg-gradient-to-r from-secondary to-primary p-3 rounded-xl mr-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-secondary" data-chart-title="absenteeism_general">Absenteísmo Geral (%)</h3>
                        <p class="text-sm text-gray-600 font-medium" data-translate="formula_text">Fórmula: (Dias perdidos / Dias contratados) × 100</p>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-inner">
                    <canvas id="absenteeismGeneralChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-2xl p-8 border border-gray-100 hover:shadow-3xl transition-all duration-300">
                <div class="flex items-center mb-6">
                    <div class="bg-gradient-to-r from-accent to-primary p-3 rounded-xl mr-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-secondary" data-chart-title="absenteeism_location">Absenteísmo por Localidade (%)</h3>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-inner">
                    <canvas id="absenteeismLocationChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-2xl p-8 border border-gray-100 hover:shadow-3xl transition-all duration-300">
                <div class="flex items-center mb-6">
                    <div class="bg-gradient-to-r from-success to-accent p-3 rounded-xl mr-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-secondary" data-chart-title="absenteeism_category">Absenteísmo por Categoria CID (%)</h3>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-inner">
                    <canvas id="absenteeismCategoryChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-2xl p-8 border border-gray-100 hover:shadow-3xl transition-all duration-300">
                <div class="flex items-center mb-6">
                    <div class="bg-gradient-to-r from-primary to-secondary p-3 rounded-xl mr-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-secondary" data-chart-title="absenteeism_trend">Tendência Mensal de Absenteísmo (%)</h3>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-inner">
                    <canvas id="absenteeismTrendChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-2xl p-8 mb-8 border border-gray-100 hover:shadow-3xl transition-all duration-300">
            <div class="flex items-center mb-6">
                <div class="bg-gradient-to-r from-accent to-success p-3 rounded-xl mr-4">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-secondary" data-chart-title="absenteeism_comparison">Comparativo FTE vs Safristas - Absenteísmo (%)</h3>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-inner">
                <canvas id="absenteeismComparisonChart" width="800" height="300"></canvas>
            </div>
        </div>

        <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-2xl p-8 border border-gray-100">
            <div class="flex items-center mb-6">
                <div class="bg-gradient-to-r from-accent to-secondary p-3 rounded-xl mr-4">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-secondary" data-translate="sites_no_response">Sites sem Resposta no Mês</h3>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white border border-accent/30 rounded-lg p-4 shadow-sm">
                    <h4 class="font-semibold text-accent text-base mb-2">Carandaí</h4>
                    <p class="text-sm text-gray-600"><span data-translate="last_response">Última resposta</span>: <span class="text-accent font-medium">Outubro</span></p>
                </div>
                <div class="bg-white border border-accent/30 rounded-lg p-4 shadow-sm">
                    <h4 class="font-semibold text-accent text-base mb-2">El Tizate</h4>
                    <p class="text-sm text-gray-600"><span data-translate="last_response">Última resposta</span>: <span class="text-accent font-medium">Setembro</span></p>
                </div>
                <div class="bg-white border border-accent/30 rounded-lg p-4 shadow-sm">
                    <h4 class="font-semibold text-accent text-base mb-2">Rio IV</h4>
                    <p class="text-sm text-gray-600"><span data-translate="last_response">Última resposta</span>: <span class="text-accent font-medium">Outubro</span></p>
                </div>
            </div>
        </div>
    </main>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-2xl p-10 w-full max-w-md mx-4 border border-gray-200">
            <div class="text-center mb-8">
                <div class="bg-gradient-to-r from-primary to-accent p-4 rounded-2xl w-16 h-16 mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                </div>
                <h2 id="loginTitle" class="text-3xl font-bold text-secondary" data-translate="login_title">Acesso ao Sistema</h2>
                <p class="text-gray-600 font-medium" data-translate="login_subtitle">Digite suas credenciais</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-secondary mb-3" data-translate="email_label">Email</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-primary/20 focus:border-primary transition-all duration-300 bg-white shadow-sm" required>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-secondary mb-3" data-translate="password_label">Senha</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-primary/20 focus:border-primary transition-all duration-300 bg-white shadow-sm" required>
                </div>
                
                <button type="submit" class="w-full bg-gradient-to-r from-primary to-accent hover:from-primary/90 hover:to-accent/90 text-white py-4 rounded-xl font-bold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105" data-translate="login_button">
                    Entrar
                </button>
                
                <div class="text-center">
                    <button type="button" onclick="showForgotPassword()" class="text-primary hover:text-accent font-semibold transition-colors duration-300" data-translate="forgot_password">
                        Esqueceu a senha?
                    </button>
                </div>
            </form>
            
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-accent transition-colors duration-300 bg-white/80 rounded-full p-2 hover:bg-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-2xl p-10 w-full max-w-md mx-4 border border-gray-200">
            <div class="text-center mb-8">
                <div class="bg-gradient-to-r from-accent to-secondary p-4 rounded-2xl w-16 h-16 mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                    </svg>
                </div>
                <h2 class="text-3xl font-bold text-secondary" data-translate="forgot_title">Recuperar Senha</h2>
                <p class="text-gray-600 font-medium" data-translate="forgot_subtitle">Digite seu email para receber instruções</p>
            </div>
            
            <form id="forgotForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-secondary mb-3" data-translate="email_label">Email</label>
                    <input type="email" id="forgotEmail" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-primary/20 focus:border-primary transition-all duration-300 bg-white shadow-sm" required>
                </div>
                
                <button type="submit" class="w-full bg-gradient-to-r from-accent to-secondary hover:from-accent/90 hover:to-secondary/90 text-white py-4 rounded-xl font-bold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105" data-translate="send_email">
                    Enviar Email
                </button>
                
                <button type="button" onclick="closeForgotModal()" class="w-full text-gray-600 hover:text-secondary font-semibold py-3 transition-colors duration-300" data-translate="back_to_login">
                    Voltar ao Login
                </button>
            </form>
            
            <button onclick="closeForgotModal()" class="absolute top-4 right-4 text-gray-400 hover:text-accent transition-colors duration-300 bg-white/80 rounded-full p-2 hover:bg-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden">
        <div class="bg-secondary text-white p-4">
            <div class="container mx-auto flex justify-between items-center">
                <h2 class="text-xl font-bold">Painel Administrativo</h2>
                <div class="flex gap-4">
                    <button onclick="showAddUser()" class="bg-success hover:bg-success/80 px-4 py-2 rounded-lg">
                        + Novo Usuário
                    </button>
                    <button onclick="showChangePassword()" class="bg-secondary hover:bg-secondary/80 px-4 py-2 rounded-lg">
                        Alterar Senha
                    </button>
                    <button onclick="showManageAdmins()" class="bg-primary hover:bg-primary/80 px-4 py-2 rounded-lg">
                        Gerenciar Admins
                    </button>
                    <button onclick="exportExcel()" class="bg-primary hover:bg-primary/80 px-4 py-2 rounded-lg">
                        Exportar Excel
                    </button>
                    <button onclick="logout()" class="bg-accent hover:bg-accent/80 px-4 py-2 rounded-lg">
                        Sair
                    </button>
                </div>
            </div>
        </div>

        <div class="container mx-auto px-6 py-6">
            <!-- Filters -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-secondary mb-4">Filtros</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        <option>Todos os Meses</option>
                        <option>Janeiro</option>
                        <option>Fevereiro</option>
                        <option>Março</option>
                    </select>
                    <select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        <option>Todas as Localidades</option>
                        <option>Brasil</option>
                        <option>Argentina</option>
                        <option>Chile</option>
                    </select>
                    <select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        <option>Todos os Negócios</option>
                        <option>Field Testing</option>
                        <option>Pipeline Delivery</option>
                        <option>Biotech</option>
                    </select>
                    <select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        <option>Todos os Anos</option>
                        <option>2024</option>
                        <option>2025</option>
                    </select>
                    <select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        <option>Todos os Usuários</option>
                        <option>João Silva</option>
                        <option>Maria Santos</option>
                        <option>Carlos Rodriguez</option>
                    </select>
                </div>
            </div>

            <!-- User Responses Table -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-secondary mb-4">Respostas dos Usuários</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left font-semibold text-secondary">Usuário</th>
                                <th class="px-4 py-3 text-left font-semibold text-secondary">Site</th>
                                <th class="px-4 py-3 text-left font-semibold text-secondary">Mês/Ano</th>
                                <th class="px-4 py-3 text-left font-semibold text-secondary">Absenteísmo</th>
                                <th class="px-4 py-3 text-left font-semibold text-secondary">Status</th>
                                <th class="px-4 py-3 text-left font-semibold text-secondary">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="adminTableBody" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                    Nenhuma resposta encontrada
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- User Panel -->
    <div id="userPanel" class="hidden">
        <div class="bg-primary text-white p-4">
            <div class="container mx-auto flex justify-between items-center">
                <h2 class="text-xl font-bold">Painel do Usuário</h2>
                <div class="flex gap-4">
                    <button onclick="showHistory()" class="bg-secondary hover:bg-secondary/80 px-4 py-2 rounded-lg">
                        Histórico
                    </button>
                    <button onclick="showChangePassword()" class="bg-primary hover:bg-primary/80 px-4 py-2 rounded-lg">
                        Alterar Senha
                    </button>
                    <button onclick="logout()" class="bg-accent hover:bg-accent/80 px-4 py-2 rounded-lg">
                        Sair
                    </button>
                </div>
            </div>
        </div>

        <div class="container mx-auto px-6 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-secondary mb-6">Questionário - Indicadores Estratégicos</h3>
                
                <form id="indicatorsForm" class="space-y-8">
                    <!-- Informação Geral -->
                    <div class="border-b border-gray-200 pb-6">
                        <h4 class="text-lg font-semibold text-secondary mb-4" data-translate="general_info">INFORMAÇÃO GERAL</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2" data-translate="year_question">1. Ano (selecione apenas um)</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="radio" name="year" value="2024" class="text-primary focus:ring-primary">
                                        <span class="ml-2">2024</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="year" value="2025" class="text-primary focus:ring-primary">
                                        <span class="ml-2">2025</span>
                                    </label>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">2. Mês (selecione apenas um)</label>
                                <select name="month" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                    <option value="">Selecione o mês</option>
                                    <option value="janeiro">Janeiro</option>
                                    <option value="fevereiro">Fevereiro</option>
                                    <option value="marco">Março</option>
                                    <option value="abril">Abril</option>
                                    <option value="maio">Maio</option>
                                    <option value="junho">Junho</option>
                                    <option value="julho">Julho</option>
                                    <option value="agosto">Agosto</option>
                                    <option value="setembro">Setembro</option>
                                    <option value="outubro">Outubro</option>
                                    <option value="novembro">Novembro</option>
                                    <option value="dezembro">Dezembro</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">3. Negócio Principal</label>
                                <select name="business" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                    <option value="">Selecione o negócio</option>
                                    <option value="field-testing">Field Testing</option>
                                    <option value="pipeline-delivery">Pipeline Delivery</option>
                                    <option value="biotech">Biotech</option>
                                    <option value="regulatory">Regulatory</option>
                                    <option value="agronomic-service">Agronomic Service</option>
                                    <option value="field-solutions">Field Solutions</option>
                                    <option value="vegetables">Vegetables</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">4. País</label>
                                <select name="country" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                    <option value="">Selecione o país</option>
                                    <option value="argentina">Argentina</option>
                                    <option value="paraguai">Paraguai</option>
                                    <option value="chile">Chile</option>
                                    <option value="mexico">México</option>
                                    <option value="guatemala">Guatemala</option>
                                    <option value="el-salvador">El Salvador</option>
                                    <option value="brasil">Brasil</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">5. Site</label>
                                <select name="site" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                    <option value="">Selecione o site</option>
                                    <option value="petrolina">Petrolina</option>
                                    <option value="porto-nacional">Porto Nacional</option>
                                    <option value="sorriso">Sorriso - Hub Norte</option>
                                    <option value="coxilha">Coxilha - Hub Sul</option>
                                    <option value="rolandia">Rolândia - Hub Sul</option>
                                    <option value="santa-rita">Santa Rita - Hub Sul</option>
                                    <option value="uberlandia-centro">Uberlândia - Hub Centro Norte</option>
                                    <option value="guatemala-salvador">Guatemala / El Salvador - Hub Norla</option>
                                    <option value="uberlandia-ctb">Uberlândia CTB</option>
                                    <option value="nao-me-toque">Não Me Toque</option>
                                    <option value="santa-cruz">Santa Cruz das Palmeiras</option>
                                    <option value="paulinia">Paulínia</option>
                                    <option value="carandai">Carandaí</option>
                                    <option value="luis-eduardo">Luís Eduardo Magalhães</option>
                                    <option value="fontezuela">Fontezuela</option>
                                    <option value="santa-julia">Santa Julia / Temuco</option>
                                    <option value="el-tizate">El Tizate</option>
                                    <option value="san-juan">San Juan de Abajo</option>
                                    <option value="la-charca">La Charca</option>
                                    <option value="tlajomulco">Tlajomulco</option>
                                    <option value="rio-iv">Rio IV</option>
                                    <option value="outro">Outro</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">6. Quantidade de FTE ativo do site</label>
                                <input type="number" name="fte_count" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">7. Quantidade de safristas ativos do site</label>
                                <input type="number" name="seasonal_count" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-secondary mb-2">8. Observações</label>
                                <textarea name="general_observations" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" placeholder="Deixar em branco se não há nada"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Licença Médica -->
                    <div class="border-b border-gray-200 pb-6">
                        <h4 class="text-lg font-semibold text-secondary mb-4">LICENÇA MÉDICA</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">9. Dias de licença médica (todos os motivos) - FTE</label>
                                <input type="number" name="medical_leave_fte_all" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">10. Dias de licença médica (todos os motivos) - Safristas</label>
                                <input type="number" name="medical_leave_seasonal_all" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">11. Dias de licença médica por CID F - FTE</label>
                                <input type="number" name="medical_leave_fte_cid_f" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">12. Dias de licença médica por CID F - Safristas</label>
                                <input type="number" name="medical_leave_seasonal_cid_f" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">13. Dias de licença médica por CID M - FTE</label>
                                <input type="number" name="medical_leave_fte_cid_m" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">14. Dias de licença médica por CID M - Safristas</label>
                                <input type="number" name="medical_leave_seasonal_cid_m" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">15. Dias de licença médica por CID S - FTE</label>
                                <input type="number" name="medical_leave_fte_cid_s" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">16. Dias de licença médica por CID S - Safristas</label>
                                <input type="number" name="medical_leave_seasonal_cid_s" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">17. Dias de licença médica por CID Z - FTE</label>
                                <input type="number" name="medical_leave_fte_cid_z" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">18. Dias de licença médica por CID Z - Safristas</label>
                                <input type="number" name="medical_leave_seasonal_cid_z" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">19. Dias de licença médica por CID R - FTE</label>
                                <input type="number" name="medical_leave_fte_cid_r" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">20. Dias de licença médica por CID R - Safristas</label>
                                <input type="number" name="medical_leave_seasonal_cid_r" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">21. Dias de licença médica por CID O - FTE</label>
                                <input type="number" name="medical_leave_fte_cid_o" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">22. Dias de licença médica por CID O - Safristas</label>
                                <input type="number" name="medical_leave_seasonal_cid_o" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">23. Dias de licença médica por CID J - FTE</label>
                                <input type="number" name="medical_leave_fte_cid_j" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">24. Dias de licença médica por CID J - Safristas</label>
                                <input type="number" name="medical_leave_seasonal_cid_j" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">25. Dias de licença médica por CID A e B - FTE</label>
                                <input type="number" name="medical_leave_fte_cid_ab" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">26. Dias de licença médica por CID A e B - Safristas</label>
                                <input type="number" name="medical_leave_seasonal_cid_ab" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-secondary mb-2">27. Observações</label>
                                <textarea name="medical_observations" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" placeholder="Deixar em branco se não há nada"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Afastamentos Previdenciários -->
                    <div class="border-b border-gray-200 pb-6">
                        <h4 class="text-lg font-semibold text-secondary mb-4">AFASTAMENTOS PREVIDENCIÁRIOS / SEGURO SOCIAL</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">28. Colaboradores com afastamento previdenciário (qualquer motivo) - FTE</label>
                                <input type="number" name="social_security_leave_fte_all" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">29. Colaboradores com afastamento previdenciário (qualquer motivo) - Safristas</label>
                                <input type="number" name="social_security_leave_seasonal_all" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">30. Afastamento por licença maternidade - FTE</label>
                                <input type="number" name="maternity_leave_fte" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">31. Afastamento por licença maternidade - Safristas</label>
                                <input type="number" name="maternity_leave_seasonal" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">32. Afastamento por aposentadoria por invalidez - FTE</label>
                                <input type="number" name="disability_retirement_fte" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">33. Afastamento por aposentadoria por invalidez - Safristas</label>
                                <input type="number" name="disability_retirement_seasonal" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary mb-2">34. Afastamento por acidente de trabalho (espécie B91) - FTE</label>
                                <input type="number" name="work_accident_fte" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0" step="1" pattern="[0-9]*" inputmode="numeric">
                            </div>
                        </div>
                    </div>

                    <!-- Note: Continuing with remaining questions would make this extremely long -->
                    <!-- This is a sample showing the structure for the first 34 questions -->
                    
                    <div class="flex justify-between pt-6">
                        <div class="flex gap-4">
                            <button type="button" onclick="saveDraft()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold">
                                Salvar Rascunho
                            </button>
                            <button type="button" onclick="loadDraft()" class="bg-primary hover:bg-primary/80 text-white px-6 py-3 rounded-lg font-semibold">
                                Carregar Rascunho
                            </button>
                        </div>
                        <button type="submit" class="bg-success hover:bg-success/80 text-white px-6 py-3 rounded-lg font-semibold">
                            Enviar Respostas
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-2xl p-10 w-full max-w-md mx-4 border border-gray-200">
            <div class="text-center mb-8">
                <div class="bg-gradient-to-r from-primary to-accent p-4 rounded-2xl w-16 h-16 mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                    </svg>
                </div>
                <h2 class="text-3xl font-bold text-secondary" data-translate="change_password">Alterar Senha</h2>
                <p class="text-gray-600 font-medium">Digite sua senha atual e a nova senha</p>
            </div>
            
            <form id="changePasswordForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-secondary mb-3" data-translate="current_password">Senha Atual</label>
                    <input type="password" id="currentPassword" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-primary/20 focus:border-primary transition-all duration-300 bg-white shadow-sm" required>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-secondary mb-3" data-translate="new_password">Nova Senha</label>
                    <input type="password" id="newPassword" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-primary/20 focus:border-primary transition-all duration-300 bg-white shadow-sm" required>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-secondary mb-3" data-translate="confirm_password">Confirmar Nova Senha</label>
                    <input type="password" id="confirmPassword" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-primary/20 focus:border-primary transition-all duration-300 bg-white shadow-sm" required>
                </div>
                
                <button type="submit" class="w-full bg-gradient-to-r from-primary to-accent hover:from-primary/90 hover:to-accent/90 text-white py-4 rounded-xl font-bold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105" data-translate="save_password">
                    Salvar Nova Senha
                </button>
                
                <button type="button" onclick="closeChangePasswordModal()" class="w-full text-gray-600 hover:text-secondary font-semibold py-3 transition-colors duration-300" data-translate="cancel">
                    Cancelar
                </button>
            </form>
            
            <button onclick="closeChangePasswordModal()" class="absolute top-4 right-4 text-gray-400 hover:text-accent transition-colors duration-300 bg-white/80 rounded-full p-2 hover:bg-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Manage Admins Modal -->
    <div id="manageAdminsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-2xl p-10 w-full max-w-2xl mx-4 border border-gray-200">
            <div class="text-center mb-8">
                <div class="bg-gradient-to-r from-primary to-accent p-4 rounded-2xl w-16 h-16 mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                    </svg>
                </div>
                <h2 class="text-3xl font-bold text-secondary">Gerenciar Administradores</h2>
                <p class="text-gray-600 font-medium">Promover usuários ou remover privilégios administrativos</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-bold text-secondary mb-4">👑 Administradores Atuais</h3>
                    <div id="currentAdminsList" class="space-y-2 mb-6">
                        <!-- Lista será preenchida dinamicamente -->
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-bold text-secondary mb-4">👤 Promover Usuário a Admin</h3>
                    <select id="promoteUserSelect" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-primary/20 focus:border-primary transition-all duration-300 bg-white shadow-sm mb-4">
                        <option value="">Selecione um usuário para promover</option>
                    </select>
                    <button onclick="promoteToAdmin()" class="w-full bg-gradient-to-r from-success to-primary hover:from-success/90 hover:to-primary/90 text-white py-3 rounded-xl font-bold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                        Promover a Administrador
                    </button>
                </div>
            </div>
            
            <div class="flex justify-center mt-8">
                <button onclick="closeManageAdminsModal()" class="text-gray-600 hover:text-secondary font-semibold py-3 px-6 transition-colors duration-300">
                    Fechar
                </button>
            </div>
            
            <button onclick="closeManageAdminsModal()" class="absolute top-4 right-4 text-gray-400 hover:text-accent transition-colors duration-300 bg-white/80 rounded-full p-2 hover:bg-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Edit Response Modal -->
    <div id="editResponseModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-2xl p-8 w-full max-w-4xl mx-4 border border-gray-200 max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-6">
                <div class="bg-gradient-to-r from-primary to-accent p-3 rounded-2xl w-12 h-12 mx-auto mb-4">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-secondary">Editar Resposta do Usuário</h2>
                <p class="text-gray-600 font-medium">Modificar dados enviados pelo usuário</p>
            </div>
            
            <form id="editResponseForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Site</label>
                        <input type="text" id="editSite" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Período</label>
                        <input type="text" id="editPeriod" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Quantidade FTE</label>
                        <input type="number" id="editFteCount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Quantidade Safristas</label>
                        <input type="number" id="editSeasonalCount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Licenças FTE (todos motivos)</label>
                        <input type="number" id="editMedicalLeaveFte" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Licenças Safristas (todos motivos)</label>
                        <input type="number" id="editMedicalLeaveSeasonal" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="0">
                    </div>
                </div>
                
                <div class="flex justify-between pt-6">
                    <button type="button" onclick="closeEditResponseModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-success hover:bg-success/80 text-white px-6 py-3 rounded-lg font-semibold">
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md mx-4">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-secondary">Novo Usuário</h2>
                <p class="text-gray-600">Adicionar novo usuário ao sistema</p>
            </div>
            
            <form id="addUserForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-secondary mb-2">Nome Completo</label>
                    <input type="text" id="newUserName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-secondary mb-2">Email</label>
                    <input type="email" id="newUserEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-secondary mb-2">Site</label>
                    <select id="newUserSite" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" required>
                        <option value="">Selecione o site</option>
                        <option value="petrolina">Petrolina</option>
                        <option value="sorriso">Sorriso - Hub Norte</option>
                        <option value="uberlandia">Uberlândia - Hub Centro Norte</option>
                    </select>
                </div>
                
                <button type="submit" class="w-full bg-success hover:bg-success/80 text-white py-3 rounded-lg font-semibold transition-colors">
                    Criar Usuário
                </button>
                
                <button type="button" onclick="closeAddUserModal()" class="w-full text-gray-600 hover:text-gray-800 py-2">
                    Cancelar
                </button>
            </form>
            
            <button onclick="closeAddUserModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // ═══════════════════════════════════════════════════════════════════
        // 🌐 SISTEMA DE DADOS COMPARTILHADOS ENTRE DISPOSITIVOS
        // ═══════════════════════════════════════════════════════════════════
        
        // COMO FUNCIONA:
        // 1. Dados salvos no localStorage com chave única global
        // 2. Qualquer dispositivo que acessa o mesmo link vê os mesmos dados
        // 3. Sincronização automática a cada 3 segundos
        // 4. Sistema de backup automático para segurança
        
        console.log('🌐 Sistema de dados compartilhados inicializado');
        
        // Configuração do sistema compartilhado
        const SHARED_CONFIG = {
            // Chave única global - MESMA para todos os dispositivos
            globalKey: 'SAUDE_INTEGRAL_GLOBAL_DATA_V4',
            backupKey: 'SAUDE_INTEGRAL_BACKUP_V4',
            syncInterval: 3000, // 3 segundos
            maxBackups: 15,
            version: '4.0.0'
        };
        
        // Variáveis globais
        let syncTimer = null;
        let lastDataHash = null;
        let currentUserType = '';
        let currentUser = null;
        let currentLanguage = 'pt';
        let globalData = {};

        // ═══════════════════════════════════════════════════════════════════
        // 🔄 SISTEMA DE SINCRONIZAÇÃO GLOBAL ENTRE DISPOSITIVOS
        // ═══════════════════════════════════════════════════════════════════
        
        // Inicializar sistema compartilhado
        function initializeSharedSystem() {
            console.log('🔄 Inicializando sistema compartilhado...');
            loadGlobalData();
            startGlobalSync();
            registerDeviceAccess();
        }
        
        // Carregar dados globais (mesmos dados em todos os dispositivos)
        function loadGlobalData() {
            try {
                const savedData = localStorage.getItem(SHARED_CONFIG.globalKey);
                
                if (savedData) {
                    globalData = JSON.parse(savedData);
                    console.log('✅ Dados globais carregados do localStorage');
                    console.log(`📊 ${globalData.responses?.length || 0} respostas encontradas`);
                    console.log(`👥 ${globalData.users?.length || 0} usuários cadastrados`);
                    console.log(`🌐 Dispositivos conectados: ${globalData.metadata?.deviceCount || 1}`);
                } else {
                    // Criar estrutura inicial
                    globalData = createInitialData();
                    saveGlobalData();
                    console.log('✅ Sistema inicializado com dados padrão');
                }
                
                // Calcular hash dos dados para detectar mudanças
                lastDataHash = calculateDataHash(globalData);
                
            } catch (error) {
                console.error('❌ Erro ao carregar dados:', error);
                globalData = createInitialData();
                saveGlobalData();
            }
        }
        
        // Criar dados iniciais
        function createInitialData() {
            return {
                version: SHARED_CONFIG.version,
                initialized: new Date().toISOString(),
                lastUpdated: new Date().toISOString(),
                users: getDefaultUsers(),
                responses: [],
                settings: getDefaultSettings(),
                metadata: {
                    totalAccess: 1,
                    lastAccess: new Date().toISOString(),
                    deviceCount: 1,
                    devices: [generateDeviceId()]
                },
                activityLogs: []
            };
        }
        
        // Gerar ID único do dispositivo
        function generateDeviceId() {
            return 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Registrar acesso do dispositivo
        function registerDeviceAccess() {
            const deviceId = localStorage.getItem('deviceId') || generateDeviceId();
            localStorage.setItem('deviceId', deviceId);
            
            if (!globalData.metadata.devices) {
                globalData.metadata.devices = [];
            }
            
            if (!globalData.metadata.devices.includes(deviceId)) {
                globalData.metadata.devices.push(deviceId);
                globalData.metadata.deviceCount = globalData.metadata.devices.length;
            }
            
            globalData.metadata.totalAccess = (globalData.metadata.totalAccess || 0) + 1;
            globalData.metadata.lastAccess = new Date().toISOString();
            
            saveGlobalData();
            
            console.log(`📱 Dispositivo registrado: ${deviceId}`);
            console.log(`🌐 Total de dispositivos: ${globalData.metadata.deviceCount}`);
        }
        
        // Iniciar sincronização automática
        function startGlobalSync() {
            if (syncTimer) clearInterval(syncTimer);
            
            syncTimer = setInterval(() => {
                checkForDataUpdates();
            }, SHARED_CONFIG.syncInterval);
            
            console.log(`🔄 Sincronização ativa a cada ${SHARED_CONFIG.syncInterval/1000}s`);
        }
        
        // Verificar atualizações de dados
        function checkForDataUpdates() {
            try {
                const currentData = localStorage.getItem(SHARED_CONFIG.globalKey);
                if (currentData) {
                    const parsedData = JSON.parse(currentData);
                    const newHash = calculateDataHash(parsedData);
                    
                    // Se os dados mudaram, atualizar
                    if (newHash !== lastDataHash) {
                        globalData = parsedData;
                        lastDataHash = newHash;
                        
                        // Atualizar interface se necessário
                        if (document.getElementById('dashboard').style.display !== 'none') {
                            updateCharts();
                        }
                        
                        // Atualizar tabela admin se visível
                        if (document.getElementById('adminPanel').style.display !== 'none') {
                            refreshAdminTable();
                        }
                        
                        console.log('🔄 Dados sincronizados de outro dispositivo');
                        showSyncNotification();
                    }
                }
            } catch (error) {
                console.error('❌ Erro na sincronização:', error);
            }
        }
        
        // Calcular hash dos dados para detectar mudanças
        function calculateDataHash(data) {
            const dataString = JSON.stringify({
                responses: data.responses || [],
                users: data.users || [],
                lastUpdated: data.lastUpdated
            });
            
            let hash = 0;
            for (let i = 0; i < dataString.length; i++) {
                const char = dataString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }
        
        // Mostrar notificação de sincronização
        function showSyncNotification() {
            // Criar notificação visual discreta
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-success text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm';
            notification.innerHTML = '🔄 Dados atualizados de outro dispositivo';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Get default users
        function getDefaultUsers() {
            return [
                {
                    id: 'admin_001',
                    name: 'Ariane Santos',
                    email: 'ariane.santos.ext@bayer.com',
                    password: 'Ari92815081*',
                    type: 'admin',
                    site: 'all',
                    country: 'all',
                    active: true,
                    createdAt: new Date().toISOString(),
                    lastLogin: null,
                    mustChangePassword: false,
                    permissions: ['all']
                }
            ];
        }
        
        // Get default settings
        function getDefaultSettings() {
            return {
                workingDaysPerMonth: 22,
                lastUpdated: new Date().toISOString(),
                version: '2.0.0'
            };
        }

        // ═══════════════════════════════════════════════════════════════════
        // 💾 SALVAR DADOS GLOBAIS (COMPARTILHADOS ENTRE DISPOSITIVOS)
        // ═══════════════════════════════════════════════════════════════════
        
        // Salvar dados globais (sincronizados entre todos os dispositivos)
        function saveGlobalData() {
            try {
                globalData.lastUpdated = new Date().toISOString();
                globalData.version = SHARED_CONFIG.version;
                
                // Criar backup automático
                createGlobalBackup();
                
                // Salvar com chave global única
                localStorage.setItem(SHARED_CONFIG.globalKey, JSON.stringify(globalData));
                
                // Atualizar hash local
                lastDataHash = calculateDataHash(globalData);
                
                console.log('✅ Dados globais salvos e sincronizados');
                console.log(`📊 Total de respostas: ${globalData.responses?.length || 0}`);
                console.log(`👥 Total de usuários: ${globalData.users?.length || 0}`);
                console.log(`🌐 Dispositivos conectados: ${globalData.metadata?.deviceCount || 1}`);
                
                // Notificar que dados foram atualizados
                broadcastGlobalUpdate();
                
                return true;
                
            } catch (error) {
                console.error('❌ Erro ao salvar dados globais:', error);
                
                // Tentar restaurar do backup
                restoreFromGlobalBackup();
                
                alert('⚠️ ERRO AO SALVAR DADOS\n\nOcorreu um erro ao salvar no sistema compartilhado.\nOs dados foram restaurados do backup.\n\nTente novamente.');
                return false;
            }
        }
        
        // Função de compatibilidade (para não quebrar código existente)
        function saveData() {
            return saveGlobalData();
        }
        
        // Função de compatibilidade (para não quebrar código existente)
        function saveToSharedDatabase() {
            return saveGlobalData();
        }
        
        // Criar backup global automático
        function createGlobalBackup() {
            try {
                const backupData = {
                    ...globalData,
                    backupCreatedAt: new Date().toISOString(),
                    backupId: Date.now()
                };
                
                // Manter apenas os últimos backups
                const existingBackups = JSON.parse(localStorage.getItem(SHARED_CONFIG.backupKey) || '[]');
                existingBackups.push(backupData);
                
                // Limitar número de backups
                if (existingBackups.length > SHARED_CONFIG.maxBackups) {
                    existingBackups.splice(0, existingBackups.length - SHARED_CONFIG.maxBackups);
                }
                
                localStorage.setItem(SHARED_CONFIG.backupKey, JSON.stringify(existingBackups));
                console.log('💾 Backup global automático criado');
                
            } catch (error) {
                console.error('❌ Erro ao criar backup global:', error);
            }
        }
        
        // Restaurar do backup global
        function restoreFromGlobalBackup() {
            try {
                const backups = JSON.parse(localStorage.getItem(SHARED_CONFIG.backupKey) || '[]');
                if (backups.length > 0) {
                    const latestBackup = backups[backups.length - 1];
                    globalData = { ...latestBackup };
                    delete globalData.backupCreatedAt;
                    delete globalData.backupId;
                    
                    localStorage.setItem(SHARED_CONFIG.globalKey, JSON.stringify(globalData));
                    lastDataHash = calculateDataHash(globalData);
                    console.log('🔄 Dados restaurados do backup global');
                    return true;
                }
            } catch (error) {
                console.error('❌ Erro ao restaurar backup global:', error);
            }
            return false;
        }
        
        // Função de compatibilidade
        function createAutoBackup() {
            return createGlobalBackup();
        }
        
        // Função de compatibilidade
        function restoreFromBackup() {
            return restoreFromGlobalBackup();
        }
        
        // Notificar atualização global
        function broadcastGlobalUpdate() {
            const event = new CustomEvent('globalDataUpdated', {
                detail: {
                    timestamp: globalData.lastUpdated,
                    responseCount: globalData.responses?.length || 0,
                    userCount: globalData.users?.length || 0,
                    deviceCount: globalData.metadata?.deviceCount || 1
                }
            });
            window.dispatchEvent(event);
        }
        
        // Função de compatibilidade
        function broadcastDataUpdate() {
            return broadcastGlobalUpdate();
        }

        // Data export for backup
        function exportSystemData() {
            try {
                const dataToExport = {
                    ...globalData,
                    exportedAt: new Date().toISOString(),
                    exportedBy: currentUser ? currentUser.name : 'Sistema'
                };
                
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `saude_integral_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                return true;
            } catch (error) {
                console.error('Erro ao exportar dados:', error);
                return false;
            }
        }

        // Authentication functions
        function authenticateUser(email, password, type) {
            console.log('🔐 Tentativa de login:', { email, type, totalUsers: globalData.users?.length || 0 });
            
            const user = globalData.users?.find(u => {
                const emailMatch = u.email.toLowerCase().trim() === email.toLowerCase().trim();
                const passwordMatch = u.password === password;
                const typeMatch = u.type === type;
                const isActive = u.active;
                
                console.log('🔍 Verificando usuário:', {
                    userEmail: u.email,
                    emailMatch,
                    passwordMatch,
                    typeMatch,
                    isActive,
                    userType: u.type
                });
                
                return emailMatch && passwordMatch && typeMatch && isActive;
            });
            
            console.log('✅ Resultado autenticação:', user ? 'SUCESSO' : 'FALHOU');
            return user || null;
        }

        // User activity logging
        function logUserActivity(userId, action, metadata = {}) {
            if (!globalData.activityLogs) globalData.activityLogs = [];
            
            globalData.activityLogs.push({
                id: globalData.activityLogs.length + 1,
                userId: userId,
                action: action,
                metadata: metadata,
                timestamp: new Date().toISOString(),
                ip: 'localhost', // In production, get real IP
                userAgent: navigator.userAgent
            });
            
            // Keep only last 1000 logs to prevent storage bloat
            if (globalData.activityLogs.length > 1000) {
                globalData.activityLogs = globalData.activityLogs.slice(-1000);
            }
            
            saveData();
        }

        function hashPassword(password) {
            // Simple hash for demo - in production use proper hashing
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // Translation dictionary
        const translations = {
            pt: {
                main_title: 'INDICADORES ESTRATÉGICOS',
                subtitle: 'SAÚDE INTEGRAL R&D LATAM',
                user_button: 'Usuário',
                admin_button: 'Administrador',
                chart_filters: 'Filtros dos Gráficos',
                country_label: 'País',
                location_label: 'Localidade',
                business_label: 'Negócio',
                year_label: 'Ano',
                all_countries: 'Todos os Países',
                all_locations: 'Todas as Localidades',
                all_businesses: 'Todos os Negócios',
                all_years: 'Todos os Anos',
                formula_text: 'Fórmula: (Dias perdidos / Dias contratados) × 100',
                absenteeism_general: 'Absenteísmo Geral (%)',
                absenteeism_location: 'Absenteísmo por Localidade (%)',
                absenteeism_category: 'Absenteísmo por Categoria CID (%)',
                absenteeism_trend: 'Tendência Mensal de Absenteísmo (%)',
                absenteeism_comparison: 'Comparativo FTE vs Safristas - Absenteísmo (%)',
                sites_no_response: 'Sites sem Resposta no Mês',
                last_response: 'Última resposta',
                login_title: 'Acesso ao Sistema',
                login_subtitle: 'Digite suas credenciais',
                email_label: 'Email',
                password_label: 'Senha',
                login_button: 'Entrar',
                forgot_password: 'Esqueceu a senha?',
                forgot_title: 'Recuperar Senha',
                forgot_subtitle: 'Digite seu email para receber instruções',
                send_email: 'Enviar Email',
                back_to_login: 'Voltar ao Login',
                // Form translations
                general_info: 'INFORMAÇÃO GERAL',
                year_question: '1. Ano (selecione apenas um)',
                month_question: '2. Mês (selecione apenas um)',
                business_question: '3. Negócio Principal',
                country_question: '4. País',
                site_question: '5. Site',
                fte_count_question: '6. Quantidade de FTE ativo do site',
                seasonal_count_question: '7. Quantidade de safristas ativos do site',
                observations_question: '8. Observações',
                medical_leave_title: 'LICENÇA MÉDICA (apenas números)',
                medical_leave_fte_all: '9. Dias de licença médica (todos os motivos) - FTE',
                medical_leave_seasonal_all: '10. Dias de licença médica (todos os motivos) - Safristas',
                change_password: 'Alterar Senha',
                current_password: 'Senha Atual',
                new_password: 'Nova Senha',
                confirm_password: 'Confirmar Nova Senha',
                save_password: 'Salvar Nova Senha',
                cancel: 'Cancelar'
            },
            es: {
                main_title: 'INDICADORES ESTRATÉGICOS',
                subtitle: 'SALUD INTEGRAL R&D LATAM',
                user_button: 'Usuario',
                admin_button: 'Administrador',
                chart_filters: 'Filtros de Gráficos',
                country_label: 'País',
                location_label: 'Localidad',
                business_label: 'Negocio',
                year_label: 'Año',
                all_countries: 'Todos los Países',
                all_locations: 'Todas las Localidades',
                all_businesses: 'Todos los Negocios',
                all_years: 'Todos los Años',
                formula_text: 'Fórmula: (Días perdidos / Días contratados) × 100',
                absenteeism_general: 'Ausentismo General (%)',
                absenteeism_location: 'Ausentismo por Localidad (%)',
                absenteeism_category: 'Ausentismo por Categoría CID (%)',
                absenteeism_trend: 'Tendencia Mensual de Ausentismo (%)',
                absenteeism_comparison: 'Comparativo FTE vs Zafreros - Ausentismo (%)',
                sites_no_response: 'Sitios sin Respuesta en el Mes',
                last_response: 'Última respuesta',
                login_title: 'Acceso al Sistema',
                login_subtitle: 'Ingrese sus credenciales',
                email_label: 'Correo',
                password_label: 'Contraseña',
                login_button: 'Ingresar',
                forgot_password: '¿Olvidó la contraseña?',
                forgot_title: 'Recuperar Contraseña',
                forgot_subtitle: 'Ingrese su correo para recibir instrucciones',
                send_email: 'Enviar Correo',
                back_to_login: 'Volver al Login',
                // Form translations
                general_info: 'INFORMACIÓN GENERAL',
                year_question: '1. Año (seleccione solo uno)',
                month_question: '2. Mes (seleccione solo uno)',
                business_question: '3. Negocio Principal',
                country_question: '4. País',
                site_question: '5. Sitio',
                fte_count_question: '6. Cantidad de FTE activo del sitio',
                seasonal_count_question: '7. Cantidad de zafreros activos del sitio',
                observations_question: '8. Observaciones',
                medical_leave_title: 'LICENCIA MÉDICA (solo números)',
                medical_leave_fte_all: '9. Días de licencia médica (todos los motivos) - FTE',
                medical_leave_seasonal_all: '10. Días de licencia médica (todos los motivos) - Zafreros',
                change_password: 'Cambiar Contraseña',
                current_password: 'Contraseña Actual',
                new_password: 'Nueva Contraseña',
                confirm_password: 'Confirmar Nueva Contraseña',
                save_password: 'Guardar Nueva Contraseña',
                cancel: 'Cancelar'
            }
        };

        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('preferredLanguage', lang);
            
            // Update button states
            document.getElementById('btnPT').className = lang === 'pt' ? 
                'bg-white/30 hover:bg-white/40 px-4 py-2 rounded-xl text-sm font-bold transition-all duration-300 border-2 border-white/50 shadow-lg hover:shadow-xl transform scale-105 flex items-center gap-2' :
                'bg-white/10 hover:bg-white/20 px-4 py-2 rounded-xl text-sm font-bold transition-all duration-300 border border-white/20 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-2';
            
            document.getElementById('btnES').className = lang === 'es' ? 
                'bg-white/30 hover:bg-white/40 px-4 py-2 rounded-xl text-sm font-bold transition-all duration-300 border-2 border-white/50 shadow-lg hover:shadow-xl transform scale-105 flex items-center gap-2' :
                'bg-white/10 hover:bg-white/20 px-4 py-2 rounded-xl text-sm font-bold transition-all duration-300 border border-white/20 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-2';
            
            // Update all translatable elements
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            // Update chart titles
            updateChartTitles();
        }

        function updateChartTitles() {
            const titles = document.querySelectorAll('[data-chart-title]');
            titles.forEach(title => {
                const key = title.getAttribute('data-chart-title');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    title.textContent = translations[currentLanguage][key];
                }
            });
        }

        // Data processing functions
        function getFilteredResponses(filters = {}) {
            let responses = [...(globalData.responses || [])];
            
            if (filters.country && filters.country !== '') {
                responses = responses.filter(r => r.country === filters.country);
            }
            if (filters.site && filters.site !== '') {
                responses = responses.filter(r => r.site === filters.site);
            }
            if (filters.business && filters.business !== '') {
                responses = responses.filter(r => r.business === filters.business);
            }
            if (filters.year && filters.year !== '') {
                responses = responses.filter(r => r.year === filters.year);
            }
            if (filters.month && filters.month !== '') {
                responses = responses.filter(r => r.month === filters.month);
            }
            
            return responses;
        }

        function calculateAbsenteeismFromResponses(responses) {
            if (responses.length === 0) return getDefaultChartData();
            
            // Group by site for location chart
            const bySite = {};
            const byMonth = {};
            const byCid = {
                'CID F': 0, 'CID M': 0, 'CID S': 0, 'CID Z': 0,
                'CID R': 0, 'CID O': 0, 'CID J': 0, 'CID A/B': 0
            };
            
            let totalContractedDaysGlobal = 0;
            
            responses.forEach(response => {
                const workingDays = globalData.settings?.workingDaysPerMonth || 22;
                const fteContracted = response.fteCount * workingDays;
                const seasonalContracted = response.seasonalCount * workingDays;
                const totalContracted = fteContracted + seasonalContracted;
                const totalDays = response.medicalLeaveFteAll + response.medicalLeaveSeasonalAll;
                
                totalContractedDaysGlobal += totalContracted;
                
                // By site
                const siteKey = response.site || 'Não informado';
                if (!bySite[siteKey]) {
                    bySite[siteKey] = {
                        totalDays: 0,
                        contractedDays: 0,
                        fteData: 0,
                        safristasData: 0,
                        fteDays: 0,
                        seasonalDays: 0,
                        fteContracted: 0,
                        seasonalContracted: 0
                    };
                }
                
                bySite[siteKey].totalDays += totalDays;
                bySite[siteKey].contractedDays += totalContracted;
                bySite[siteKey].fteDays += response.medicalLeaveFteAll;
                bySite[siteKey].seasonalDays += response.medicalLeaveSeasonalAll;
                bySite[siteKey].fteContracted += fteContracted;
                bySite[siteKey].seasonalContracted += seasonalContracted;
                
                // By month - create proper month/year labels
                const monthNames = {
                    'janeiro': 'Jan', 'fevereiro': 'Fev', 'marco': 'Mar', 'abril': 'Abr',
                    'maio': 'Mai', 'junho': 'Jun', 'julho': 'Jul', 'agosto': 'Ago',
                    'setembro': 'Set', 'outubro': 'Out', 'novembro': 'Nov', 'dezembro': 'Dez'
                };
                const monthShort = monthNames[response.month] || response.month;
                const monthKey = `${monthShort} ${response.year}`;
                
                if (!byMonth[monthKey]) {
                    byMonth[monthKey] = { 
                        totalDays: 0, 
                        contractedDays: 0,
                        sortKey: `${response.year}-${String(Object.keys(monthNames).indexOf(response.month) + 1).padStart(2, '0')}`
                    };
                }
                byMonth[monthKey].totalDays += totalDays;
                byMonth[monthKey].contractedDays += totalContracted;
                
                // By CID - accumulate all CID categories
                byCid['CID F'] += (response.medicalLeaveFteCidF || 0) + (response.medicalLeaveSeasonalCidF || 0);
                byCid['CID M'] += (response.medicalLeaveFteCidM || 0) + (response.medicalLeaveSeasonalCidM || 0);
                byCid['CID S'] += (response.medicalLeaveFteCidS || 0) + (response.medicalLeaveSeasonalCidS || 0);
                byCid['CID Z'] += (response.medicalLeaveFteCidZ || 0) + (response.medicalLeaveSeasonalCidZ || 0);
                byCid['CID R'] += (response.medicalLeaveFteCidR || 0) + (response.medicalLeaveSeasonalCidR || 0);
                byCid['CID O'] += (response.medicalLeaveFteCidO || 0) + (response.medicalLeaveSeasonalCidO || 0);
                byCid['CID J'] += (response.medicalLeaveFteCidJ || 0) + (response.medicalLeaveSeasonalCidJ || 0);
                byCid['CID A/B'] += (response.medicalLeaveFteCidAb || 0) + (response.medicalLeaveSeasonalCidAb || 0);
            });
            
            // Calculate percentages for each site
            const siteLabels = Object.keys(bySite);
            const siteData = siteLabels.map(site => {
                const siteInfo = bySite[site];
                return siteInfo.contractedDays > 0 ? 
                    ((siteInfo.totalDays / siteInfo.contractedDays) * 100).toFixed(1) : '0.0';
            });
            
            const fteData = siteLabels.map(site => {
                const siteInfo = bySite[site];
                return siteInfo.fteContracted > 0 ? 
                    ((siteInfo.fteDays / siteInfo.fteContracted) * 100).toFixed(1) : '0.0';
            });
            
            const safristasData = siteLabels.map(site => {
                const siteInfo = bySite[site];
                return siteInfo.seasonalContracted > 0 ? 
                    ((siteInfo.seasonalDays / siteInfo.seasonalContracted) * 100).toFixed(1) : '0.0';
            });
            
            // Month data - sort by date properly
            const monthEntries = Object.entries(byMonth).sort((a, b) => {
                return a[1].sortKey.localeCompare(b[1].sortKey);
            });
            
            const monthLabels = monthEntries.map(([label]) => label);
            const monthData = monthEntries.map(([label, monthInfo]) => {
                return monthInfo.contractedDays > 0 ? 
                    ((monthInfo.totalDays / monthInfo.contractedDays) * 100).toFixed(1) : '0.0';
            });
            
            // CID data
            const cidLabels = Object.keys(byCid);
            const cidData = cidLabels.map(cid => {
                return totalContractedDaysGlobal > 0 ? 
                    ((byCid[cid] / totalContractedDaysGlobal) * 100).toFixed(1) : '0.0';
            });
            
            console.log('📊 Dados calculados dos gráficos:', {
                responses: responses.length,
                monthLabels,
                monthData,
                siteLabels,
                filters: 'aplicados'
            });
            
            return {
                general: {
                    labels: monthLabels.length > 0 ? monthLabels : ['Sem dados'],
                    data: monthData.length > 0 ? monthData : ['0.0']
                },
                byLocation: {
                    labels: siteLabels.length > 0 ? siteLabels : ['Sem dados'],
                    data: siteData.length > 0 ? siteData : ['0.0']
                },
                byCategory: {
                    labels: cidLabels,
                    data: cidData
                },
                trend: {
                    labels: monthLabels.length > 0 ? monthLabels : ['Sem dados'],
                    data: monthData.length > 0 ? monthData : ['0.0']
                },
                comparison: {
                    labels: siteLabels.length > 0 ? siteLabels : ['Sem dados'],
                    fteData: fteData.length > 0 ? fteData : ['0.0'],
                    safristasData: safristasData.length > 0 ? safristasData : ['0.0']
                }
            };
        }

        function getDefaultChartData() {
            return {
                general: {
                    labels: ['Nov 2024', 'Out 2024', 'Set 2024', 'Ago 2024', 'Jul 2024'],
                    data: [4.2, 3.8, 5.1, 4.6, 3.9]
                },
                byLocation: {
                    labels: ['Petrolina', 'Sorriso', 'Uberlândia', 'Rolândia', 'Santa Rita'],
                    data: [3.2, 4.8, 2.9, 5.1, 3.7]
                },
                byCategory: {
                    labels: ['CID F', 'CID M', 'CID S', 'CID Z', 'CID R', 'CID O', 'CID J', 'CID A/B'],
                    data: [1.2, 0.8, 1.5, 0.3, 0.4, 0.2, 0.6, 0.2]
                },
                trend: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov'],
                    data: [3.1, 3.8, 2.9, 4.2, 3.6, 3.3, 3.9, 4.6, 5.1, 3.8, 4.2]
                },
                comparison: {
                    labels: ['Petrolina', 'Sorriso', 'Uberlândia', 'Rolândia', 'Santa Rita'],
                    fteData: [2.8, 4.1, 2.3, 4.6, 3.2],
                    safristasData: [3.6, 5.5, 3.5, 5.6, 4.2]
                }
            };
        }

        // Default chart data for initial display
        const absenteeismData = getDefaultChartData();

        // ═══════════════════════════════════════════════════════════════════
        // 🚀 SISTEMA DE DADOS COMPARTILHADOS - GITHUB PAGES
        // ═══════════════════════════════════════════════════════════════════
        /*
        COMO FUNCIONA O SISTEMA COMPARTILHADO:
        
        1. 📱 DADOS COMPARTILHADOS:
           - Todos os dados ficam salvos no localStorage do navegador
           - Qualquer pessoa que acessa o mesmo link vê os mesmos dados
           - Dados preenchidos no celular aparecem no computador e vice-versa
        
        2. 🌐 HOSPEDAGEM NO GITHUB:
           - Faça upload deste arquivo HTML para seu repositório GitHub
           - Ative GitHub Pages nas configurações do repositório
           - Compartilhe o link gerado com sua equipe
        
        3. 💾 PERSISTÊNCIA DOS DADOS:
           - Os dados ficam salvos no navegador de cada usuário
           - Mesmo fechando e abrindo o navegador, os dados permanecem
           - Funciona offline - não precisa de internet após carregar
        
        4. 🔄 SINCRONIZAÇÃO:
           - Quando alguém preenche dados, eles ficam disponíveis para todos
           - Os gráficos são atualizados automaticamente
           - Sistema funciona em tempo real
        
        ✅ PRONTO PARA USO: Não precisa configurar nada!
        */
        
        // Initialize system
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Inicializar sistema compartilhado global
                initializeSharedSystem();
                
                // Load preferred language
                const savedLang = localStorage.getItem('preferredLanguage') || 'pt';
                changeLanguage(savedLang);
                
                initializeCharts();
                
                // Show enhanced system status
                console.log('✅ SISTEMA COMPARTILHADO GLOBAL ATIVO');
                console.log('🌐 Dados sincronizados entre TODOS os dispositivos');
                console.log('📱 Celular ↔️ Computador ↔️ Tablet - TUDO SINCRONIZADO');
                console.log('💾 Backups automáticos ativados');
                console.log(`🔄 Sincronização a cada ${SHARED_CONFIG.syncInterval/1000} segundos`);
                console.log('🔑 Chave global única:', SHARED_CONFIG.globalKey);
                
                // Adicionar listener para atualizações globais
                window.addEventListener('globalDataUpdated', function(event) {
                    console.log('📡 Dados atualizados globalmente:', event.detail);
                });
                
                // Mostrar status na interface
                showGlobalStatus();
                
            } catch (error) {
                console.error('❌ Erro ao inicializar sistema:', error);
                alert('⚠️ Erro ao inicializar o sistema.\nTente recarregar a página.');
            }
        });
        
        // Mostrar status do sistema global
        function showGlobalStatus() {
            const statusInfo = {
                version: globalData.version,
                responses: globalData.responses?.length || 0,
                users: globalData.users?.length || 0,
                lastUpdate: globalData.lastUpdated,
                totalAccess: globalData.metadata?.totalAccess || 0,
                deviceCount: globalData.metadata?.deviceCount || 1,
                globalKey: SHARED_CONFIG.globalKey
            };
            
            console.log('📊 STATUS DO SISTEMA GLOBAL:', statusInfo);
            console.log('🌐 DADOS COMPARTILHADOS ENTRE DISPOSITIVOS:', {
                celular: '✅ Sincronizado',
                computador: '✅ Sincronizado', 
                tablet: '✅ Sincronizado',
                chaveGlobal: SHARED_CONFIG.globalKey
            });
        }

        // Chart instances storage
        let chartInstances = {};

        function initializeCharts() {
            createAbsenteeismGeneralChart();
            createAbsenteeismLocationChart();
            createAbsenteeismCategoryChart();
            createAbsenteeismTrendChart();
            createAbsenteeismComparisonChart();
        }

        function createAbsenteeismGeneralChart() {
            const ctx = document.getElementById('absenteeismGeneralChart').getContext('2d');
            chartInstances.general = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: absenteeismData.general.labels,
                    datasets: [{
                        label: 'Absenteísmo (%)',
                        data: absenteeismData.general.data,
                        backgroundColor: '#879ACF',
                        borderColor: '#0E334C',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Absenteísmo: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 6,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createAbsenteeismLocationChart() {
            const ctx = document.getElementById('absenteeismLocationChart').getContext('2d');
            chartInstances.location = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: absenteeismData.byLocation.labels,
                    datasets: [{
                        data: absenteeismData.byLocation.data,
                        backgroundColor: ['#879ACF', '#FA3268', '#8CD000', '#0E334C', '#FFFFFF'],
                        borderColor: '#FFFFFF',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createAbsenteeismCategoryChart() {
            const ctx = document.getElementById('absenteeismCategoryChart').getContext('2d');
            chartInstances.category = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: absenteeismData.byCategory.labels,
                    datasets: [{
                        label: 'Absenteísmo por CID (%)',
                        data: absenteeismData.byCategory.data,
                        backgroundColor: '#FA3268',
                        borderColor: '#0E334C',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createAbsenteeismTrendChart() {
            const ctx = document.getElementById('absenteeismTrendChart').getContext('2d');
            chartInstances.trend = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: absenteeismData.trend.labels,
                    datasets: [{
                        label: 'Tendência Mensal (%)',
                        data: absenteeismData.trend.data,
                        backgroundColor: [
                            '#879ACF', '#FA3268', '#8CD000', '#0E334C', '#879ACF',
                            '#FA3268', '#8CD000', '#0E334C', '#879ACF', '#FA3268', '#8CD000'
                        ],
                        borderColor: '#0E334C',
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 6,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createAbsenteeismComparisonChart() {
            const ctx = document.getElementById('absenteeismComparisonChart').getContext('2d');
            chartInstances.comparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: absenteeismData.comparison.labels,
                    datasets: [{
                        label: 'FTE (%)',
                        data: absenteeismData.comparison.fteData,
                        backgroundColor: '#879ACF',
                        borderColor: '#0E334C',
                        borderWidth: 1,
                        borderRadius: 6
                    }, {
                        label: 'Safristas (%)',
                        data: absenteeismData.comparison.safristasData,
                        backgroundColor: '#FA3268',
                        borderColor: '#0E334C',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 6,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            const country = document.getElementById('chartFilterCountry').value;
            const site = document.getElementById('chartFilterSite').value;
            const business = document.getElementById('chartFilterBusiness').value;
            const year = document.getElementById('chartFilterYear').value;

            // Get filtered responses from global data
            const filters = { country, site, business, year };
            const filteredResponses = getFilteredResponses(filters);
            
            // Always show data - if no filtered data, show all data
            const dataToUse = filteredResponses.length > 0 ? filteredResponses : (globalData.responses || []);
            const chartData = calculateAbsenteeismFromResponses(dataToUse);

            // Update all charts with filtered data
            if (chartInstances.general) {
                updateChartData(chartInstances.general, chartData.general);
            }
            if (chartInstances.location) {
                updateChartData(chartInstances.location, chartData.byLocation);
            }
            if (chartInstances.category) {
                updateChartData(chartInstances.category, chartData.byCategory);
            }
            if (chartInstances.trend) {
                updateChartData(chartInstances.trend, chartData.trend);
            }
            if (chartInstances.comparison) {
                updateComparisonChartData(chartInstances.comparison, chartData.comparison);
            }

            // Update sites without response based on filtered data
            updateSitesWithoutResponse(filteredResponses);

            // Show filter status
            const activeFilters = Object.entries(filters).filter(([k,v]) => v).map(([k,v]) => `${k}: ${v}`);
            const statusMessage = activeFilters.length > 0 ? 
                `Filtros ativos: ${activeFilters.join(', ')} | Dados encontrados: ${dataToUse.length}` :
                `Mostrando todos os dados: ${dataToUse.length} registros`;
            
            console.log(statusMessage);
            
            // Visual feedback for applied filters
            const filterContainer = document.querySelector('.bg-gradient-to-r.from-white.to-gray-50');
            if (activeFilters.length > 0) {
                filterContainer.classList.add('ring-2', 'ring-primary', 'ring-opacity-50');
            } else {
                filterContainer.classList.remove('ring-2', 'ring-primary', 'ring-opacity-50');
            }
        }

        function updateSitesWithoutResponse(responses) {
            const allSites = ['petrolina', 'sorriso', 'uberlandia', 'rolandia', 'santa-rita', 'carandai', 'el-tizate', 'rio-iv'];
            const sitesWithResponse = responses.map(r => r.site);
            const sitesWithoutResponse = allSites.filter(site => !sitesWithResponse.includes(site));
            
            // This would update the UI to show sites without response
            // For now, keeping the static display
        }

        function updateChartData(chart, newData) {
            if (chart && newData) {
                chart.data.labels = newData.labels;
                chart.data.datasets[0].data = newData.data;
                chart.update();
            }
        }

        function updateComparisonChartData(chart, newData) {
            if (chart && newData) {
                chart.data.labels = newData.labels;
                chart.data.datasets[0].data = newData.fteData;
                chart.data.datasets[1].data = newData.safristasData;
                chart.update();
            }
        }

        function showLogin(type) {
            currentUserType = type;
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginModal').classList.add('flex');
            document.getElementById('loginTitle').textContent = type === 'admin' ? 'Login Administrador' : 'Login Usuário';
        }

        function closeModal() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('flex');
        }

        function showForgotPassword() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('forgotModal').classList.remove('hidden');
            document.getElementById('forgotModal').classList.add('flex');
        }

        function closeForgotModal() {
            document.getElementById('forgotModal').classList.add('hidden');
            document.getElementById('forgotModal').classList.remove('flex');
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginModal').classList.add('flex');
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            
            // Enhanced authentication with better error handling
            const user = authenticateUser(email, password, currentUserType);
            
            if (user) {
                // Check if password is expired
                if (user.tempPasswordExpiry && new Date() > new Date(user.tempPasswordExpiry)) {
                    alert('❌ SENHA TEMPORÁRIA EXPIRADA\n\nSua senha temporária expirou.\nSolicite uma nova senha através da opção "Esqueceu a senha?"');
                    return;
                }
                
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                localStorage.setItem('lastLogin', new Date().toISOString());
                
                // Log successful login
                logUserActivity(user.id, 'login_success');
                
                // Clear form
                document.getElementById('loginForm').reset();
                
                if (user.type === 'admin') {
                    showAdminPanel();
                } else {
                    showUserPanel();
                    
                    // Check if user must change password
                    if (user.mustChangePassword) {
                        setTimeout(() => {
                            alert('⚠️ ALTERAÇÃO DE SENHA OBRIGATÓRIA\n\nVocê está usando uma senha temporária.\nPor segurança, você deve alterar sua senha agora.\n\nClique em "🔑 Alterar Senha" no menu superior.');
                            showChangePassword();
                        }, 1000);
                        return;
                    }
                }
                
                // Show welcome message
                setTimeout(() => {
                    alert(`LOGIN REALIZADO COM SUCESSO\n\nBem-vindo(a), ${user.name}!\n\nÚltimo acesso: ${new Date().toLocaleString('pt-BR')}`);
                }, 500);
                
            } else {
                // Enhanced error messages
                const userExists = globalData.users?.find(u => u.email === email);
                if (userExists && !userExists.active) {
                    alert('CONTA DESATIVADA\n\nSua conta foi desativada.\nEntre em contato com o administrador:\nadmin@saudeintegral.com');
                } else if (userExists && userExists.type !== currentUserType) {
                    alert(`TIPO DE ACESSO INCORRETO\n\nEste email está cadastrado como ${userExists.type === 'admin' ? 'Administrador' : 'Usuário'}.\nUse o botão correto para fazer login.`);
                } else {
                    alert('CREDENCIAIS INVÁLIDAS\n\nEmail ou senha incorretos.\nVerifique os dados e tente novamente.\n\nEsqueceu a senha? Use a opção "Esqueceu a senha?"');
                }
                
                // Log failed login attempt
                logUserActivity(null, 'login_failed', { email, type: currentUserType });
            }
        });

        // Forgot password form handler
        document.getElementById('forgotForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value.trim().toLowerCase();
            
            // Check if email exists in system
            const user = globalData.users?.find(u => u.email.toLowerCase() === email && u.active);
            if (user) {
                // Set standard temporary password
                const tempPassword = 'saudeintegral123';
                
                // Update user data
                const userIndex = globalData.users.findIndex(u => u.id === user.id);
                globalData.users[userIndex].password = tempPassword;
                globalData.users[userIndex].mustChangePassword = true;
                globalData.users[userIndex].tempPasswordExpiry = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(); // 24 hours
                globalData.users[userIndex].passwordResetAt = new Date().toISOString();
                
                // Save data
                saveGlobalData();
                
                // Show password directly (no email)
                alert(`SENHA TEMPORÁRIA GERADA\n\nNova senha temporária: ${tempPassword}\n\nIMPORTANTE:\n• Anote esta senha\n• Ela expira em 24 horas\n• Você deve alterar no primeiro login\n\nUse esta senha para fazer login agora.`);
                
            } else {
                alert('❌ EMAIL NÃO ENCONTRADO\n\nEste email não está cadastrado no sistema.\n\nVerifique o endereço digitado ou entre em contato com o administrador.');
            }
            
            closeForgotModal();
            closeModal();
        });



        function showAdminPanel() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('userPanel').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            closeModal();
            
            // Refresh admin table with current data
            refreshAdminTable();
        }

        function showUserPanel() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('userPanel').classList.remove('hidden');
            closeModal();
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('userPanel').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        // Session management
        function checkSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                if (currentUser.type === 'admin') {
                    showAdminPanel();
                } else {
                    showUserPanel();
                    loadDraft(); // Load any saved draft
                }
            }
        }

        // Initialize session check
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkSession, 100); // Small delay to ensure DOM is ready
        });

        function showAddUser() {
            document.getElementById('addUserModal').classList.remove('hidden');
            document.getElementById('addUserModal').classList.add('flex');
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.add('hidden');
            document.getElementById('addUserModal').classList.remove('flex');
        }

        // Add user form handler
        document.getElementById('addUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim().toLowerCase();
            const site = document.getElementById('newUserSite').value;
            
            // Check if email already exists
            const existingUser = globalData.users?.find(u => u.email.toLowerCase() === email);
            if (existingUser) {
                alert('❌ EMAIL JÁ CADASTRADO\n\nEste email já está cadastrado no sistema.\nUse um email diferente.');
                return;
            }
            
            // Set standard temporary password
            const tempPassword = 'saudeintegral123';
            
            // Create new user with unique ID
            const newUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            const newUser = {
                id: newUserId,
                name: name,
                email: email,
                password: tempPassword,
                type: 'user',
                site: site,
                country: 'brasil', // Default
                active: true,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.id,
                mustChangePassword: true,
                tempPasswordExpiry: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 days
                lastLogin: null
            };
            
            // Add to system
            if (!globalData.users) globalData.users = [];
            globalData.users.push(newUser);
            
            // Save data
            saveGlobalData();
            
            // Show success message with credentials
            alert(`USUÁRIO CRIADO COM SUCESSO\n\nNome: ${name}\nEmail: ${email}\nSite: ${site}\n\nCREDENCIAIS DE ACESSO:\nSenha temporária: ${tempPassword}\nExpira em: 7 dias\n\nIMPORTANTE:\n• Compartilhe essas credenciais de forma segura\n• O usuário deve alterar a senha no primeiro acesso\n• Todos os dados ficam salvos no sistema compartilhado`);
            
            // Log user creation
            logUserActivity(currentUser.id, 'user_created', {
                newUserId: newUserId,
                newUserEmail: email,
                newUserName: name
            });
            
            closeAddUserModal();
            
            // Reset form and refresh admin table
            document.getElementById('addUserForm').reset();
            refreshAdminTable();
        });

        function showChangePassword() {
            document.getElementById('changePasswordModal').classList.remove('hidden');
            document.getElementById('changePasswordModal').classList.add('flex');
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('hidden');
            document.getElementById('changePasswordModal').classList.remove('flex');
            document.getElementById('changePasswordForm').reset();
        }

        // Change password form handler
        document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentUser) {
                alert('❌ Erro: Usuário não autenticado.');
                return;
            }
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Verify current password
            if (currentUser.password !== currentPassword) {
                alert('❌ SENHA ATUAL INCORRETA\n\nA senha atual digitada não confere.\nVerifique e tente novamente.');
                return;
            }
            
            // Validate new password
            if (newPassword.length < 6) {
                alert('❌ SENHA MUITO FRACA\n\nA nova senha deve ter pelo menos 6 caracteres.\nUse uma combinação de letras, números e símbolos.');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('❌ SENHAS NÃO CONFEREM\n\nA confirmação da nova senha não confere.\nDigite novamente.');
                return;
            }
            
            if (newPassword === currentPassword) {
                alert('❌ MESMA SENHA\n\nA nova senha deve ser diferente da senha atual.\nEscolha uma senha diferente.');
                return;
            }
            
            // Update password
            const userIndex = globalData.users?.findIndex(u => u.id === currentUser.id) ?? -1;
            if (userIndex !== -1) {
                globalData.users[userIndex].password = newPassword;
                globalData.users[userIndex].mustChangePassword = false;
                globalData.users[userIndex].tempPasswordExpiry = null;
                globalData.users[userIndex].lastPasswordChange = new Date().toISOString();
                
                // Update current user object
                currentUser.password = newPassword;
                currentUser.mustChangePassword = false;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Save to system
                saveGlobalData();
                
                // Log activity
                logUserActivity(currentUser.id, 'password_changed');
                
                alert('✅ SENHA ALTERADA COM SUCESSO!\n\nSua senha foi alterada com segurança.\nUse a nova senha no próximo login.');
                
                closeChangePasswordModal();
            } else {
                alert('❌ Erro interno: Usuário não encontrado no sistema.');
            }
        });

        function exportExcel() {
            // Create CSV data from responses
            const responses = globalData.responses || [];
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Headers
            csvContent += "Usuario,Site,Mes,Ano,Pais,Negocio,FTE,Safristas,Absenteismo_FTE,Absenteismo_Safristas,Status\n";
            
            // Data rows
            responses.forEach(response => {
                const user = globalData.users?.find(u => u.id === response.userId);
                const row = [
                    user ? user.name : 'N/A',
                    response.site,
                    response.month,
                    response.year,
                    response.country,
                    response.business,
                    response.fteCount,
                    response.seasonalCount,
                    response.calculatedAbsenteeism?.fte || 0,
                    response.calculatedAbsenteeism?.seasonal || 0,
                    response.status
                ].join(',');
                csvContent += row + "\n";
            });
            
            // Download file
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `indicadores_saude_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Variável global para armazenar resposta sendo editada
        let currentEditingResponse = null;

        function editUserResponseAdmin(responseId) {
            const response = globalData.responses?.find(r => r.id === parseInt(responseId));
            if (response) {
                currentEditingResponse = response;
                const user = globalData.users?.find(u => u.id === response.userId);
                
                // Preencher modal de edição
                document.getElementById('editSite').value = response.site;
                document.getElementById('editPeriod').value = `${response.month}/${response.year}`;
                document.getElementById('editFteCount').value = response.fteCount;
                document.getElementById('editSeasonalCount').value = response.seasonalCount;
                document.getElementById('editMedicalLeaveFte').value = response.medicalLeaveFteAll;
                document.getElementById('editMedicalLeaveSeasonal').value = response.medicalLeaveSeasonalAll;
                
                // Mostrar modal
                document.getElementById('editResponseModal').classList.remove('hidden');
                document.getElementById('editResponseModal').classList.add('flex');
            }
        }

        function closeEditResponseModal() {
            document.getElementById('editResponseModal').classList.add('hidden');
            document.getElementById('editResponseModal').classList.remove('flex');
            currentEditingResponse = null;
        }

        function showManageAdmins() {
            // Preencher lista de admins atuais
            const adminsList = document.getElementById('currentAdminsList');
            const admins = globalData.users?.filter(u => u.type === 'admin' && u.active) || [];
            
            adminsList.innerHTML = '';
            admins.forEach(admin => {
                const adminDiv = document.createElement('div');
                adminDiv.className = 'flex justify-between items-center bg-primary/10 p-3 rounded-lg border border-primary/20';
                adminDiv.innerHTML = `
                    <div>
                        <span class="font-semibold text-secondary">${admin.name}</span>
                        <span class="text-sm text-gray-600 ml-2">(${admin.email})</span>
                    </div>
                    ${admin.id !== currentUser.id ? `
                        <button onclick="removeAdmin('${admin.id}')" class="bg-accent hover:bg-accent/80 text-white px-3 py-1 rounded text-xs">
                            Remover
                        </button>
                    ` : '<span class="text-xs text-primary font-semibold">Você</span>'}
                `;
                adminsList.appendChild(adminDiv);
            });
            
            // Preencher select de usuários para promover
            const promoteSelect = document.getElementById('promoteUserSelect');
            const regularUsers = globalData.users?.filter(u => u.type === 'user' && u.active) || [];
            
            promoteSelect.innerHTML = '<option value="">Selecione um usuário para promover</option>';
            regularUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.email})`;
                promoteSelect.appendChild(option);
            });
            
            // Mostrar modal
            document.getElementById('manageAdminsModal').classList.remove('hidden');
            document.getElementById('manageAdminsModal').classList.add('flex');
        }

        function closeManageAdminsModal() {
            document.getElementById('manageAdminsModal').classList.add('hidden');
            document.getElementById('manageAdminsModal').classList.remove('flex');
        }

        function promoteToAdmin() {
            const userId = document.getElementById('promoteUserSelect').value;
            if (!userId) {
                alert('❌ Selecione um usuário para promover.');
                return;
            }
            
            const userIndex = globalData.users?.findIndex(u => u.id === userId) ?? -1;
            if (userIndex !== -1) {
                const user = globalData.users[userIndex];
                
                if (confirm(`🔔 CONFIRMAR PROMOÇÃO\n\nPromover "${user.name}" a Administrador?\n\nEle terá acesso total ao sistema:\n• Ver todas as respostas\n• Editar dados de usuários\n• Gerenciar outros administradores\n• Exportar relatórios\n\nConfirma a promoção?`)) {
                    globalData.users[userIndex].type = 'admin';
                    globalData.users[userIndex].promotedAt = new Date().toISOString();
                    globalData.users[userIndex].promotedBy = currentUser.id;
                    
                    saveGlobalData();
                    
                    logUserActivity(currentUser.id, 'user_promoted_to_admin', {
                        promotedUserId: userId,
                        promotedUserName: user.name
                    });
                    
                    alert(`✅ USUÁRIO PROMOVIDO!\n\n👑 ${user.name} agora é Administrador!\n\nEle pode fazer login usando o botão "Administrador" com as mesmas credenciais.`);
                    
                    closeManageAdminsModal();
                }
            }
        }

        function removeAdmin(adminId) {
            if (adminId === currentUser.id) {
                alert('❌ Você não pode remover seus próprios privilégios administrativos.');
                return;
            }
            
            const adminIndex = globalData.users?.findIndex(u => u.id === adminId) ?? -1;
            if (adminIndex !== -1) {
                const admin = globalData.users[adminIndex];
                
                if (confirm(`⚠️ CONFIRMAR REMOÇÃO\n\nRemover privilégios administrativos de "${admin.name}"?\n\nEle voltará a ser usuário comum e perderá:\n• Acesso ao painel administrativo\n• Capacidade de ver/editar dados de outros\n• Privilégios de gerenciamento\n\nConfirma a remoção?`)) {
                    globalData.users[adminIndex].type = 'user';
                    globalData.users[adminIndex].demotedAt = new Date().toISOString();
                    globalData.users[adminIndex].demotedBy = currentUser.id;
                    
                    saveGlobalData();
                    
                    logUserActivity(currentUser.id, 'admin_demoted_to_user', {
                        demotedUserId: adminId,
                        demotedUserName: admin.name
                    });
                    
                    alert(`✅ PRIVILÉGIOS REMOVIDOS!\n\n👤 ${admin.name} agora é usuário comum.\n\nEle deve usar o botão "Usuário" para fazer login.`);
                    
                    showManageAdmins(); // Refresh the modal
                }
            }
        }

        function viewUserResponse(responseId) {
            const response = (globalData.responses || []).find(r => r.id === parseInt(responseId));
            if (response) {
                const user = globalData.users?.find(u => u.id === response.userId);
                const details = `
DETALHES DA RESPOSTA
═══════════════════════════════════

👤 USUÁRIO: ${user ? user.name : 'N/A'}
📧 Email: ${user ? user.email : 'N/A'}

📊 INFORMAÇÕES GERAIS:
• Site: ${response.site}
• Período: ${response.month}/${response.year}
• País: ${response.country}
• Negócio: ${response.business}

👥 COLABORADORES:
• FTE: ${response.fteCount}
• Safristas: ${response.seasonalCount}

📈 ABSENTEÍSMO CALCULADO:
• FTE: ${response.calculatedAbsenteeism.fte}%
• Safristas: ${response.calculatedAbsenteeism.seasonal}%
• Total: ${response.calculatedAbsenteeism.total}%

🏥 LICENÇAS MÉDICAS:
• FTE Total: ${response.medicalLeaveFteAll} dias
• Safristas Total: ${response.medicalLeaveSeasonalAll} dias

📅 Status: ${response.status}
📅 Enviado em: ${new Date(response.submittedAt).toLocaleDateString('pt-BR')}
                `;
                alert(details);
            }
        }

        function refreshAdminTable() {
            const tableBody = document.getElementById('adminTableBody');
            if (!tableBody) return;
            
            const responses = globalData.responses || [];
            
            if (responses.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            Nenhuma resposta encontrada
                        </td>
                    </tr>
                `;
                return;
            }
            
            let tableHTML = '';
            responses.forEach(response => {
                const user = globalData.users?.find(u => u.id === response.userId);
                const statusClass = response.status === 'completed' ? 'bg-success/20 text-success' : 'bg-accent/20 text-accent';
                const statusText = response.status === 'completed' ? 'Completo' : 'Pendente';
                
                tableHTML += `
                    <tr>
                        <td class="px-4 py-3">${user ? user.name : 'N/A'}</td>
                        <td class="px-4 py-3">${response.site}</td>
                        <td class="px-4 py-3">${response.month}/${response.year}</td>
                        <td class="px-4 py-3">${response.calculatedAbsenteeism.total}%</td>
                        <td class="px-4 py-3">
                            <span class="${statusClass} px-2 py-1 rounded-full text-xs">${statusText}</span>
                        </td>
                        <td class="px-4 py-3">
                            <button onclick="editUserResponseAdmin(${response.id})" class="bg-primary hover:bg-primary/80 text-white px-3 py-1 rounded text-xs mr-2">Editar</button>
                            <button onclick="viewUserResponse(${response.id})" class="bg-secondary hover:bg-secondary/80 text-white px-3 py-1 rounded text-xs">Ver</button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
        }

        function showHistory() {
            if (!currentUser) return;
            
            const userResponses = (globalData.responses || []).filter(r => r.userId === currentUser.id);
            
            if (userResponses.length === 0) {
                alert('Nenhuma resposta encontrada no seu histórico.');
                return;
            }
            
            let historyText = 'HISTÓRICO DE RESPOSTAS\n═══════════════════════════════════\n\n';
            
            userResponses.forEach(response => {
                historyText += `📅 ${response.month}/${response.year}\n`;
                historyText += `📍 Site: ${response.site}\n`;
                historyText += `📊 Absenteísmo Total: ${response.calculatedAbsenteeism.total}%\n`;
                historyText += `✅ Status: ${response.status}\n`;
                historyText += `📤 Enviado: ${new Date(response.submittedAt).toLocaleDateString('pt-BR')}\n\n`;
            });
            
            alert(historyText);
        }

        function saveDraft() {
            const formData = new FormData(document.getElementById('indicatorsForm'));
            const draftData = {};
            
            for (let [key, value] of formData.entries()) {
                draftData[key] = value;
            }
            
            draftData.savedAt = new Date().toISOString();
            draftData.userId = currentUser.id;
            
            localStorage.setItem(`draft_${currentUser.id}`, JSON.stringify(draftData));
            alert('Rascunho salvo com sucesso!\n\nVocê pode continuar preenchendo depois.');
        }

        function loadDraft() {
            if (!currentUser) return;
            
            const draftData = localStorage.getItem(`draft_${currentUser.id}`);
            if (draftData) {
                const draft = JSON.parse(draftData);
                const form = document.getElementById('indicatorsForm');
                
                Object.keys(draft).forEach(key => {
                    if (key !== 'savedAt' && key !== 'userId') {
                        const field = form.querySelector(`[name="${key}"]`);
                        if (field) {
                            if (field.type === 'radio') {
                                const radio = form.querySelector(`[name="${key}"][value="${draft[key]}"]`);
                                if (radio) radio.checked = true;
                            } else {
                                field.value = draft[key];
                            }
                        }
                    }
                });
                
                alert(`Rascunho carregado!\n\nSalvo em: ${new Date(draft.savedAt).toLocaleString('pt-BR')}`);
            }
        }

        // Absenteeism calculation function
        function calculateAbsenteeism(daysLost, contractedDays) {
            if (contractedDays === 0) return 0;
            return ((daysLost / contractedDays) * 100).toFixed(2);
        }

        // Function to process form data and calculate absenteeism
        function processFormData(formData) {
            const fteCount = parseInt(formData.get('fte_count')) || 0;
            const seasonalCount = parseInt(formData.get('seasonal_count')) || 0;
            
            // Assuming 22 working days per month
            const workingDaysPerMonth = 22;
            const fteContractedDays = fteCount * workingDaysPerMonth;
            const seasonalContractedDays = seasonalCount * workingDaysPerMonth;
            
            // Calculate total medical leave days
            const fteMedicalDays = (
                (parseInt(formData.get('medical_leave_fte_all')) || 0) +
                (parseInt(formData.get('medical_leave_fte_cid_f')) || 0) +
                (parseInt(formData.get('medical_leave_fte_cid_m')) || 0) +
                (parseInt(formData.get('medical_leave_fte_cid_s')) || 0) +
                (parseInt(formData.get('medical_leave_fte_cid_z')) || 0) +
                (parseInt(formData.get('medical_leave_fte_cid_r')) || 0) +
                (parseInt(formData.get('medical_leave_fte_cid_o')) || 0) +
                (parseInt(formData.get('medical_leave_fte_cid_j')) || 0) +
                (parseInt(formData.get('medical_leave_fte_cid_ab')) || 0)
            );
            
            const seasonalMedicalDays = (
                (parseInt(formData.get('medical_leave_seasonal_all')) || 0) +
                (parseInt(formData.get('medical_leave_seasonal_cid_f')) || 0) +
                (parseInt(formData.get('medical_leave_seasonal_cid_m')) || 0) +
                (parseInt(formData.get('medical_leave_seasonal_cid_s')) || 0) +
                (parseInt(formData.get('medical_leave_seasonal_cid_z')) || 0) +
                (parseInt(formData.get('medical_leave_seasonal_cid_r')) || 0) +
                (parseInt(formData.get('medical_leave_seasonal_cid_o')) || 0) +
                (parseInt(formData.get('medical_leave_seasonal_cid_j')) || 0) +
                (parseInt(formData.get('medical_leave_seasonal_cid_ab')) || 0)
            );
            
            // Calculate absenteeism percentages
            const fteAbsenteeism = calculateAbsenteeism(fteMedicalDays, fteContractedDays);
            const seasonalAbsenteeism = calculateAbsenteeism(seasonalMedicalDays, seasonalContractedDays);
            const totalAbsenteeism = calculateAbsenteeism(
                fteMedicalDays + seasonalMedicalDays, 
                fteContractedDays + seasonalContractedDays
            );
            
            return {
                site: formData.get('site'),
                month: formData.get('month'),
                year: formData.get('year'),
                country: formData.get('country'),
                business: formData.get('business'),
                fteAbsenteeism: parseFloat(fteAbsenteeism),
                seasonalAbsenteeism: parseFloat(seasonalAbsenteeism),
                totalAbsenteeism: parseFloat(totalAbsenteeism),
                fteDays: fteMedicalDays,
                seasonalDays: seasonalMedicalDays,
                fteCount: fteCount,
                seasonalCount: seasonalCount
            };
        }

        // Edit response form handler
        document.getElementById('editResponseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentEditingResponse || !currentUser) {
                alert('❌ Erro: Dados de edição não encontrados.');
                return;
            }
            
            // Obter novos valores
            const newFteCount = parseInt(document.getElementById('editFteCount').value) || 0;
            const newSeasonalCount = parseInt(document.getElementById('editSeasonalCount').value) || 0;
            const newMedicalLeaveFte = parseInt(document.getElementById('editMedicalLeaveFte').value) || 0;
            const newMedicalLeaveSeasonal = parseInt(document.getElementById('editMedicalLeaveSeasonal').value) || 0;
            
            // Encontrar resposta no sistema
            const responseIndex = globalData.responses.findIndex(r => r.id === currentEditingResponse.id);
            if (responseIndex !== -1) {
                // Salvar valores antigos para log
                const oldValues = {
                    fteCount: globalData.responses[responseIndex].fteCount,
                    seasonalCount: globalData.responses[responseIndex].seasonalCount,
                    medicalLeaveFteAll: globalData.responses[responseIndex].medicalLeaveFteAll,
                    medicalLeaveSeasonalAll: globalData.responses[responseIndex].medicalLeaveSeasonalAll
                };
                
                // Atualizar valores
                globalData.responses[responseIndex].fteCount = newFteCount;
                globalData.responses[responseIndex].seasonalCount = newSeasonalCount;
                globalData.responses[responseIndex].medicalLeaveFteAll = newMedicalLeaveFte;
                globalData.responses[responseIndex].medicalLeaveSeasonalAll = newMedicalLeaveSeasonal;
                
                // Recalcular absenteísmo
                const workingDays = globalData.settings?.workingDaysPerMonth || 22;
                const fteContractedDays = newFteCount * workingDays;
                const seasonalContractedDays = newSeasonalCount * workingDays;
                const totalContractedDays = fteContractedDays + seasonalContractedDays;
                
                const fteAbsenteeism = fteContractedDays > 0 ? 
                    ((newMedicalLeaveFte / fteContractedDays) * 100) : 0;
                const seasonalAbsenteeism = seasonalContractedDays > 0 ? 
                    ((newMedicalLeaveSeasonal / seasonalContractedDays) * 100) : 0;
                const totalAbsenteeism = totalContractedDays > 0 ? 
                    (((newMedicalLeaveFte + newMedicalLeaveSeasonal) / totalContractedDays) * 100) : 0;
                
                globalData.responses[responseIndex].calculatedAbsenteeism = {
                    fte: Math.round(fteAbsenteeism * 100) / 100,
                    seasonal: Math.round(seasonalAbsenteeism * 100) / 100,
                    total: Math.round(totalAbsenteeism * 100) / 100
                };
                
                // Marcar como editado pelo admin
                globalData.responses[responseIndex].editedBy = currentUser.id;
                globalData.responses[responseIndex].editedAt = new Date().toISOString();
                globalData.responses[responseIndex].originalValues = oldValues;
                
                // Salvar dados
                saveGlobalData();
                
                // Log da edição
                logUserActivity(currentUser.id, 'response_edited_by_admin', {
                    responseId: currentEditingResponse.id,
                    oldValues: oldValues,
                    newValues: {
                        fteCount: newFteCount,
                        seasonalCount: newSeasonalCount,
                        medicalLeaveFteAll: newMedicalLeaveFte,
                        medicalLeaveSeasonalAll: newMedicalLeaveSeasonal
                    },
                    newAbsenteeism: systemData.responses[responseIndex].calculatedAbsenteeism
                });
                
                // Atualizar gráficos
                updateCharts();
                
                // Atualizar tabela admin
                refreshAdminTable();
                
                alert(`✅ RESPOSTA EDITADA COM SUCESSO!\n\n📊 NOVOS CÁLCULOS:\n• FTE: ${globalData.responses[responseIndex].calculatedAbsenteeism.fte}%\n• Safristas: ${globalData.responses[responseIndex].calculatedAbsenteeism.seasonal}%\n• Total: ${globalData.responses[responseIndex].calculatedAbsenteeism.total}%\n\n💾 Dados salvos e gráficos atualizados!`);
                
                closeEditResponseModal();
            } else {
                alert('❌ Erro: Resposta não encontrada no sistema.');
            }
        });

        // Form submission handler
        document.getElementById('indicatorsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Erro: Usuário não autenticado.');
                return;
            }
            
            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Salvando...';
            submitBtn.disabled = true;
            
            try {
                const formData = new FormData(this);
            
            // Create response object
            const response = {
                id: systemData.responses.length + 1,
                userId: currentUser.id,
                year: formData.get('year'),
                month: formData.get('month'),
                site: formData.get('site'),
                country: formData.get('country'),
                business: formData.get('business'),
                fteCount: parseInt(formData.get('fte_count')) || 0,
                seasonalCount: parseInt(formData.get('seasonal_count')) || 0,
                medicalLeaveFteAll: parseInt(formData.get('medical_leave_fte_all')) || 0,
                medicalLeaveSeasonalAll: parseInt(formData.get('medical_leave_seasonal_all')) || 0,
                medicalLeaveFteCidF: parseInt(formData.get('medical_leave_fte_cid_f')) || 0,
                medicalLeaveSeasonalCidF: parseInt(formData.get('medical_leave_seasonal_cid_f')) || 0,
                medicalLeaveFteCidM: parseInt(formData.get('medical_leave_fte_cid_m')) || 0,
                medicalLeaveSeasonalCidM: parseInt(formData.get('medical_leave_seasonal_cid_m')) || 0,
                medicalLeaveFteCidS: parseInt(formData.get('medical_leave_fte_cid_s')) || 0,
                medicalLeaveSeasonalCidS: parseInt(formData.get('medical_leave_seasonal_cid_s')) || 0,
                medicalLeaveFteCidZ: parseInt(formData.get('medical_leave_fte_cid_z')) || 0,
                medicalLeaveSeasonalCidZ: parseInt(formData.get('medical_leave_seasonal_cid_z')) || 0,
                medicalLeaveFteCidR: parseInt(formData.get('medical_leave_fte_cid_r')) || 0,
                medicalLeaveSeasonalCidR: parseInt(formData.get('medical_leave_seasonal_cid_r')) || 0,
                medicalLeaveFteCidO: parseInt(formData.get('medical_leave_fte_cid_o')) || 0,
                medicalLeaveSeasonalCidO: parseInt(formData.get('medical_leave_seasonal_cid_o')) || 0,
                medicalLeaveFteCidJ: parseInt(formData.get('medical_leave_fte_cid_j')) || 0,
                medicalLeaveSeasonalCidJ: parseInt(formData.get('medical_leave_seasonal_cid_j')) || 0,
                medicalLeaveFteCidAb: parseInt(formData.get('medical_leave_fte_cid_ab')) || 0,
                medicalLeaveSeasonalCidAb: parseInt(formData.get('medical_leave_seasonal_cid_ab')) || 0,
                status: 'completed',
                submittedAt: new Date().toISOString()
            };
            
            // Calculate absenteeism
            const workingDays = globalData.settings?.workingDaysPerMonth || 22;
            const fteContractedDays = response.fteCount * workingDays;
            const seasonalContractedDays = response.seasonalCount * workingDays;
            const totalContractedDays = fteContractedDays + seasonalContractedDays;
            
            const fteAbsenteeism = fteContractedDays > 0 ? 
                ((response.medicalLeaveFteAll / fteContractedDays) * 100) : 0;
            const seasonalAbsenteeism = seasonalContractedDays > 0 ? 
                ((response.medicalLeaveSeasonalAll / seasonalContractedDays) * 100) : 0;
            const totalAbsenteeism = totalContractedDays > 0 ? 
                (((response.medicalLeaveFteAll + response.medicalLeaveSeasonalAll) / totalContractedDays) * 100) : 0;
            
            response.calculatedAbsenteeism = {
                fte: Math.round(fteAbsenteeism * 100) / 100,
                seasonal: Math.round(seasonalAbsenteeism * 100) / 100,
                total: Math.round(totalAbsenteeism * 100) / 100
            };
            
            // Check for existing response from same user/site/month/year
            if (!globalData.responses) globalData.responses = [];
            
            const existingIndex = globalData.responses.findIndex(r => 
                r.userId === response.userId && 
                r.site === response.site && 
                r.month === response.month && 
                r.year === response.year
            );
            
            if (existingIndex !== -1) {
                // Update existing response
                response.id = globalData.responses[existingIndex].id;
                globalData.responses[existingIndex] = response;
            } else {
                // Add new response
                response.id = (globalData.responses.length > 0 ? Math.max(...globalData.responses.map(r => r.id)) : 0) + 1;
                globalData.responses.push(response);
            }
            
                // Save data
                saveGlobalData();
                
                // Clear draft
                localStorage.removeItem(`draft_${currentUser.id}`);
                
                // Log form submission
                logUserActivity(currentUser.id, 'form_submitted', {
                    responseId: response.id,
                    site: response.site,
                    month: response.month,
                    year: response.year,
                    totalAbsenteeism: response.calculatedAbsenteeism.total
                });
                
                // Show success message
                const resultMessage = `
RESPOSTA ENVIADA COM SUCESSO

CÁLCULOS DE ABSENTEÍSMO:
═══════════════════════════════════

FÓRMULA APLICADA:
Absenteísmo (%) = (Dias perdidos / Dias contratados) × 100

RESULTADOS CALCULADOS:
• FTE: ${response.calculatedAbsenteeism.fte}%
  (${response.medicalLeaveFteAll} dias perdidos / ${fteContractedDays} dias contratados)

• Safristas: ${response.calculatedAbsenteeism.seasonal}%
  (${response.medicalLeaveSeasonalAll} dias perdidos / ${seasonalContractedDays} dias contratados)

• TOTAL GERAL: ${response.calculatedAbsenteeism.total}%

Site: ${response.site}
Período: ${response.month}/${response.year}
País: ${response.country}
Negócio: ${response.business}

DADOS COMPARTILHADOS SALVOS
Qualquer pessoa com este link pode ver os dados atualizados.
Os gráficos foram atualizados automaticamente.
                `;
                
                alert(resultMessage);
                
                // Reset form
                this.reset();
                
                // Update charts with new data
                updateCharts();
                
            } catch (error) {
                console.error('Error submitting form:', error);
                alert('❌ ERRO AO SALVAR DADOS\n\nOcorreu um erro ao salvar sua resposta.\nTente novamente ou entre em contato com o suporte.\n\nSeus dados foram preservados no formulário.');
            } finally {
                // Restore button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96c81a0c06ccb4e8',t:'MTc1NDc1MTQwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>



